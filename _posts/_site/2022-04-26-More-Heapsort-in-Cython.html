<p>This post/notebook is the follow-up to a recent one : <a href="https://aetperf.github.io/2022/04/14/Heapsort-with-Numba-and-Cython.html">Heapsort with Numba and Cython</a>, where we implemented <em>heapsort</em> in Python/Numba and Cython and compared the execution time with NumPy <em>heapsort</em>. However, <em>heapsort</em> in NumPy is written in C++ (wrapped in Python) and not exactly the same implementation as the one we used in the <a href="https://aetperf.github.io/2022/04/14/Heapsort-with-Numba-and-Cython.html">previous post</a>. So in the following, we present two different <em>heapsort</em> implementations translated into Cython, which are a little bit more refined than the previous one:</p>
<ul>
  <li>the first one (<code class="language-plaintext highlighter-rouge">Cython_1</code>) is taken from the book <em>Numerical recipes in C</em> [1]</li>
  <li>the second one (<code class="language-plaintext highlighter-rouge">Cython_2</code>) is taken from NumPy source code: <a href="https://github.com/numpy/numpy/blob/main/numpy/core/src/npysort/heapsort.cpp">heapsort.cpp</a></li>
</ul>

<p>In both implementations, indices are 1-based and left bitwise shift (<code class="language-plaintext highlighter-rouge">&lt;&lt;</code>) and right bitwise shift (<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>) operators are used. In order to use 1-based indices with NumPy arrays, we add an extra element at the beginning:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">heapsort</span><span class="p">(</span><span class="n">A_in</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A_in</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">]),</span> <span class="n">A</span><span class="p">))</span>
    <span class="nf">_heapsort</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</code></pre></div></div>
<p>Also, the algorithms are implemented in a single function, and without recursion.</p>

<h2 id="imports">Imports</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">gc</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>

<span class="kn">import</span> <span class="n">cython</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">perfplot</span>

<span class="o">%</span><span class="n">load_ext</span> <span class="n">cython</span>
<span class="n">SD</span> <span class="o">=</span> <span class="mi">124</span>  <span class="c1"># random seed
</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">default_rng</span><span class="p">(</span><span class="n">SD</span><span class="p">)</span>  <span class="c1"># random number generator
</span></code></pre></div></div>

<h2 id="float-array-creation">Float array creation</h2>

<p>We still assume that we want to sort an NumPy array of 64-bit floating-point numbers between 0 and 1:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="nf">random</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">A</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([0.78525311, 0.78585936, 0.96913602, 0.74805977, 0.65555081,
       0.93888454, 0.17861445, 0.58864721, 0.44279917, 0.34884712])
</code></pre></div></div>

<h2 id="cython_1">Cython_1</h2>

<p>The authors of <em>Numerical recipes in C</em> [1] use a “corporate hierarchy metaphor”:</p>

<blockquote>
  <p>[…] a heap has every “supervisor” greater than or equal to its two “supervisees,” down through the levels of the hierarchy.</p>
</blockquote>

<blockquote>
  <p>If you have managed to rearrange your array into an order that forms a heap, then sorting it is very easy: You pull off the “top of the heap,” which will be the largest element yet unsorted. Then you “promote” to the top of the heap its largest underling. Then you promote its largest underling, and so on. The process is like what happens (or is supposed to happen) in a large corporation when the chairman of the board retires. You then repeat the whole process by retiring the new chairman of the board.</p>
</blockquote>

<blockquote>
  <p>Imagine that the corporation starts out with N/2 employees on the production line, but with no supervisors. Now a supervisor is hired to supervise two workers. If he is less capable than one of his workers, that one is promoted in his place, and he joins the production line. After supervisors are hired, then supervisors of supervisors are hired, and so on up the corporate ladder. Each employee is brought in at the top of the tree, but then immediately sifted down, with more capable workers promoted until their proper corporate level has been reached.</p>
</blockquote>

<blockquote>
  <p>One execution of the Heapsort function represents the entire life-cycle of a giant corporation: N/2 workers are hired; N/2 potential supervisors are hired; there is a sifting up in the ranks, a sort of super Peter Principle: in due course, each of the original employees gets promoted to chairman of the board.</p>
</blockquote>

<p>So we have two phases:</p>
<ul>
  <li>hiring</li>
  <li>retirement-and-promotion</li>
</ul>

<p>This is very similar to what we described in the <a href="https://aetperf.github.io/2022/04/14/Heapsort-with-Numba-and-Cython.html">previous post</a>: a first step where we build the heap in a bottom-up approach, a second step where we keep on extracting the root until the heap is empty. Both steps rely on a sift-down process. However, we have here a single main loop for both phases.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">cython</span> <span class="o">-</span><span class="mi">3</span> <span class="o">--</span><span class="nb">compile</span><span class="o">-</span><span class="n">args</span><span class="o">=-</span><span class="n">Ofast</span>

<span class="c1"># cython: boundscheck=False, cdivision=True, initializedcheck=False, wraparound=False
</span>
<span class="kn">import</span> <span class="n">cython</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">cython</span> <span class="kn">import</span> <span class="n">double</span><span class="p">,</span> <span class="n">ssize_t</span>


<span class="nd">@cython.exceptval</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.nogil</span>
<span class="nd">@cython.cfunc</span>
<span class="k">def</span> <span class="nf">_heapsort_1</span><span class="p">(</span><span class="n">ra</span><span class="p">:</span> <span class="n">double</span><span class="p">[::</span><span class="mi">1</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">cython</span><span class="p">.</span><span class="n">void</span><span class="p">:</span>
    <span class="n">i</span><span class="p">:</span> <span class="n">ssize_t</span>
    <span class="n">ir</span><span class="p">:</span> <span class="n">ssize_t</span>
    <span class="n">j</span><span class="p">:</span> <span class="n">ssize_t</span>
    <span class="n">l</span><span class="p">:</span> <span class="n">ssize_t</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">ssize_t</span> <span class="o">=</span> <span class="n">ra</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">rra</span><span class="p">:</span> <span class="n">double</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="n">n</span>

    <span class="c1"># The index l will be decremented from its initial value down to 1 during the “hiring” (heap
</span>    <span class="c1"># creation) phase. Once it reaches 1, the index ir will be decremented from its initial value
</span>    <span class="c1"># down to 1 during the “retirement-and-promotion” (heap selection) phase.
</span>    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Still in hiring phase.
</span>            <span class="n">l</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">rra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># In retirement-and-promotion phase.
</span>            <span class="n">rra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span>  <span class="c1"># Clear a space at end of array.
</span>            <span class="n">ra</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Retire the top of the heap into it.
</span>            <span class="n">ir</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Done with the last promotion
</span>                <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rra</span>  <span class="c1"># The least competent worker of all!
</span>                <span class="k">break</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">l</span>  <span class="c1"># Whether in the hiring phase or promotion phase, we
</span>        <span class="n">j</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">l</span>  <span class="c1"># here set up to sift down element rra to its proper level.
</span>        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">ir</span><span class="p">:</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">ir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ra</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Compare to the better underling.
</span>                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">rra</span> <span class="o">&lt;</span> <span class="n">ra</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>  <span class="c1"># Demote rra.
</span>                <span class="n">ra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># j = ir + 1  # This is rra's level. Set j to terminate the sift-down.
</span>                <span class="k">break</span>
        <span class="n">ra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rra</span>  <span class="c1"># Put rra into its slot.
</span>

<span class="nd">@cython.ccall</span>
<span class="k">def</span> <span class="nf">heapsort_cython_1</span><span class="p">(</span><span class="n">A_in</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A_in</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">]),</span> <span class="n">A</span><span class="p">))</span>
    <span class="nf">_heapsort_1</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">A_1</span> <span class="o">=</span> <span class="nf">heapsort_cython_1</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">A_1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([0.17861445, 0.34884712, 0.44279917, 0.58864721, 0.65555081,
       0.74805977, 0.78525311, 0.78585936, 0.93888454, 0.96913602])
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">A_1</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="cython_2">Cython_2</h2>

<p>This is a straight translation of <a href="https://github.com/numpy/numpy/blob/main/numpy/core/src/npysort/heapsort.cpp">NumPy Source code</a> from C++ to Cython. Here is what we can read in the source code about its origin:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> * These sorting functions are copied almost directly from numarray
 * with a few modifications (complex comparisons compare the imaginary
 * part if the real parts are equal, for example), and the names
 * are changed.
 *
 * The original sorting code is due to Charles R. Harris who wrote
 * it for numarray.
</code></pre></div></div>

<p>This time we have two distinct loops in the <code class="language-plaintext highlighter-rouge">_heapsort_2()</code> function. But this is very similar to the code above (Cython_1).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">cython</span> <span class="o">-</span><span class="mi">3</span> <span class="o">--</span><span class="nb">compile</span><span class="o">-</span><span class="n">args</span><span class="o">=-</span><span class="n">Ofast</span>

<span class="c1"># cython: boundscheck=False, cdivision=True, initializedcheck=False, wraparound=False
</span>
<span class="kn">import</span> <span class="n">cython</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">cython</span> <span class="kn">import</span> <span class="n">double</span><span class="p">,</span> <span class="n">ssize_t</span>


<span class="nd">@cython.exceptval</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.nogil</span>
<span class="nd">@cython.cfunc</span>
<span class="k">def</span> <span class="nf">_heapsort_2</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">double</span><span class="p">[::</span><span class="mi">1</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">cython</span><span class="p">.</span><span class="n">void</span><span class="p">:</span>
    <span class="n">i</span><span class="p">:</span> <span class="n">ssize_t</span>
    <span class="n">j</span><span class="p">:</span> <span class="n">ssize_t</span>
    <span class="n">l</span><span class="p">:</span> <span class="n">ssize_t</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">ssize_t</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">tmp</span><span class="p">:</span> <span class="n">double</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">l</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">l</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="n">j</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="n">j</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>


<span class="nd">@cython.ccall</span>
<span class="k">def</span> <span class="nf">heapsort_cython_2</span><span class="p">(</span><span class="n">A_in</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A_in</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">]),</span> <span class="n">A</span><span class="p">))</span>
    <span class="nf">_heapsort_2</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">A_2</span> <span class="o">=</span> <span class="nf">heapsort_cython_2</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">A_2</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="cython_3">Cython_3</h2>

<p>For the sake of completeness, we also included the implementation from the <a href="https://aetperf.github.io/2022/04/14/Heapsort-with-Numba-and-Cython.html">previous post</a>, with the same compiler directives as above:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">cython</span> <span class="o">-</span><span class="mi">3</span> <span class="o">--</span><span class="nb">compile</span><span class="o">-</span><span class="n">args</span><span class="o">=-</span><span class="n">Ofast</span>

<span class="c1"># cython: boundscheck=False, cdivision=True, initializedcheck=False, wraparound=False
</span>
<span class="kn">import</span> <span class="n">cython</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">cython</span> <span class="kn">import</span> <span class="n">double</span><span class="p">,</span> <span class="n">ssize_t</span>


<span class="nd">@cython.exceptval</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.nogil</span>
<span class="nd">@cython.cfunc</span>
<span class="k">def</span> <span class="nf">_max_heapify</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">double</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">:</span> <span class="n">ssize_t</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">:</span> <span class="n">ssize_t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cython</span><span class="p">.</span><span class="n">void</span><span class="p">:</span>
    <span class="n">largest</span><span class="p">:</span> <span class="n">ssize_t</span> <span class="o">=</span> <span class="n">node_idx</span>

    <span class="n">left_child</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">node_idx</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">right_child</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">node_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">left_child</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">left_child</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">A</span><span class="p">[</span><span class="n">largest</span><span class="p">]:</span>
        <span class="n">largest</span> <span class="o">=</span> <span class="n">left_child</span>

    <span class="k">if</span> <span class="n">right_child</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">right_child</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">A</span><span class="p">[</span><span class="n">largest</span><span class="p">]:</span>
        <span class="n">largest</span> <span class="o">=</span> <span class="n">right_child</span>

    <span class="k">if</span> <span class="n">largest</span> <span class="o">!=</span> <span class="n">node_idx</span><span class="p">:</span>
        <span class="n">A</span><span class="p">[</span><span class="n">node_idx</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">largest</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">largest</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">node_idx</span><span class="p">]</span>
        <span class="nf">_max_heapify</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">largest</span><span class="p">)</span>


<span class="nd">@cython.exceptval</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.nogil</span>
<span class="nd">@cython.cfunc</span>
<span class="k">def</span> <span class="nf">_heapsort_3</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">double</span><span class="p">[::</span><span class="mi">1</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">cython</span><span class="p">.</span><span class="n">void</span><span class="p">:</span>
    <span class="n">i</span><span class="p">:</span> <span class="n">cython</span><span class="p">.</span><span class="nb">int</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">ssize_t</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">node_idx</span><span class="p">:</span> <span class="n">ssize_t</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">node_idx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="nf">_max_heapify</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="nf">_max_heapify</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="nd">@cython.ccall</span>
<span class="k">def</span> <span class="nf">heapsort_cython_3</span><span class="p">(</span><span class="n">A_in</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A_in</span><span class="p">)</span>
    <span class="nf">_heapsort_3</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">A_3</span> <span class="o">=</span> <span class="nf">heapsort_cython_3</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">A_3</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="performance-comparison">Performance comparison</h2>

<p>Again, we compare the different versions against NumPy <em>heapsort</em>.</p>

<h3 id="perfplot">Perfplot</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span> <span class="o">=</span> <span class="n">perfplot</span><span class="p">.</span><span class="nf">bench</span><span class="p">(</span>
    <span class="n">setup</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">rng</span><span class="p">.</span><span class="nf">random</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="n">kernels</span><span class="o">=</span><span class="p">[</span>
        <span class="k">lambda</span> <span class="n">A</span><span class="p">:</span> <span class="nf">heapsort_cython_1</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
        <span class="k">lambda</span> <span class="n">A</span><span class="p">:</span> <span class="nf">heapsort_cython_2</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
        <span class="k">lambda</span> <span class="n">A</span><span class="p">:</span> <span class="nf">heapsort_cython_3</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
        <span class="k">lambda</span> <span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">heapsort</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">Cython_1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Cython_2</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Cython_3</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NumPy</span><span class="sh">"</span><span class="p">],</span>
    <span class="n">n_range</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)],</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">timings_s</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">out</span><span class="p">.</span><span class="n">n_range</span><span class="p">)</span>
<span class="n">t_df</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Cython_1</th>
      <th>Cython_2</th>
      <th>Cython_3</th>
      <th>NumPy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>10</th>
      <td>3.915e-06</td>
      <td>3.908e-06</td>
      <td>1.663e-06</td>
      <td>1.737e-06</td>
    </tr>
    <tr>
      <th>100</th>
      <td>5.111e-06</td>
      <td>4.890e-06</td>
      <td>5.054e-06</td>
      <td>2.977e-06</td>
    </tr>
    <tr>
      <th>1000</th>
      <td>5.326e-05</td>
      <td>5.319e-05</td>
      <td>7.090e-05</td>
      <td>6.266e-05</td>
    </tr>
    <tr>
      <th>10000</th>
      <td>8.942e-04</td>
      <td>9.227e-04</td>
      <td>8.871e-04</td>
      <td>9.634e-04</td>
    </tr>
    <tr>
      <th>100000</th>
      <td>1.202e-02</td>
      <td>1.200e-02</td>
      <td>1.272e-02</td>
      <td>1.315e-02</td>
    </tr>
    <tr>
      <th>1000000</th>
      <td>1.779e-01</td>
      <td>1.735e-01</td>
      <td>2.202e-01</td>
      <td>1.973e-01</td>
    </tr>
    <tr>
      <th>10000000</th>
      <td>2.666e+00</td>
      <td>2.654e+00</td>
      <td>4.641e+00</td>
      <td>3.066e+00</td>
    </tr>
    <tr>
      <th>100000000</th>
      <td>3.740e+01</td>
      <td>3.695e+01</td>
      <td>7.699e+01</td>
      <td>4.161e+01</td>
    </tr>
  </tbody>
</table>
</div>

<p>So is seems that the <code class="language-plaintext highlighter-rouge">Cython_1</code> and <code class="language-plaintext highlighter-rouge">Cython_2</code> implementations achieve similar speed as NumPy’s version. However, the <code class="language-plaintext highlighter-rouge">Cython_3</code> implementation is clearly slower when the array gets larger.</p>

<h3 id="a-larger-array">A Larger array</h3>

<p>It is possible to run the algorithms on arrays with 1 billion elements, but without using <code class="language-plaintext highlighter-rouge">perfplot</code> for reasons related to memory capacity of the computer used to run the tests.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="nf">random</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float64</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 4.05 s, sys: 679 ms, total: 4.72 s
Wall time: 4.72 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">timings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">A_1</span> <span class="o">=</span> <span class="nf">heapsort_cython_1</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">del</span> <span class="n">A_1</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
    <span class="n">timings</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span>
<span class="n">elapsed_time_1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">amin</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">timings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">A_2</span> <span class="o">=</span> <span class="nf">heapsort_cython_2</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">del</span> <span class="n">A_2</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
    <span class="n">timings</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span>
<span class="n">elapsed_time_2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">amin</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">timings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">A_3</span> <span class="o">=</span> <span class="nf">heapsort_cython_3</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">del</span> <span class="n">A_3</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
    <span class="n">timings</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span>
<span class="n">elapsed_time_3</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">amin</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">timings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">A_4</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">heapsort</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">del</span> <span class="n">A_4</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
    <span class="n">timings</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span>
<span class="n">elapsed_time_4</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">amin</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">t_df</span><span class="p">,</span>
        <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">elapsed_time_1</span><span class="p">,</span> <span class="n">elapsed_time_2</span><span class="p">,</span> <span class="n">elapsed_time_3</span><span class="p">,</span> <span class="n">elapsed_time_4</span><span class="p">]],</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">k</span><span class="p">],</span>
        <span class="p">),</span>
    <span class="p">],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">t_df</span><span class="p">[</span><span class="sh">"</span><span class="s">n log(n)</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0e-8</span> <span class="o">*</span> <span class="n">t_df</span><span class="p">.</span><span class="n">index</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">t_df</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
</code></pre></div></div>

<p>Note that we also included the curve corresponding to $O(n\log n)$ in the following figure. However, we are aware that this is an asymptotic behavior on an abstract machine, but do not take into account some hardware effects, such has cache optimization.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t_df</span><span class="p">[[</span><span class="sh">'</span><span class="s">Cython_1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Cython_2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Cython_3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">NumPy</span><span class="sh">'</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Cython_1</th>
      <th>Cython_2</th>
      <th>Cython_3</th>
      <th>NumPy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>10</th>
      <td>3.915e-06</td>
      <td>3.908e-06</td>
      <td>1.663e-06</td>
      <td>1.737e-06</td>
    </tr>
    <tr>
      <th>100</th>
      <td>5.111e-06</td>
      <td>4.890e-06</td>
      <td>5.054e-06</td>
      <td>2.977e-06</td>
    </tr>
    <tr>
      <th>1000</th>
      <td>5.326e-05</td>
      <td>5.319e-05</td>
      <td>7.090e-05</td>
      <td>6.266e-05</td>
    </tr>
    <tr>
      <th>10000</th>
      <td>8.942e-04</td>
      <td>9.227e-04</td>
      <td>8.871e-04</td>
      <td>9.634e-04</td>
    </tr>
    <tr>
      <th>100000</th>
      <td>1.202e-02</td>
      <td>1.200e-02</td>
      <td>1.272e-02</td>
      <td>1.315e-02</td>
    </tr>
    <tr>
      <th>1000000</th>
      <td>1.779e-01</td>
      <td>1.735e-01</td>
      <td>2.202e-01</td>
      <td>1.973e-01</td>
    </tr>
    <tr>
      <th>10000000</th>
      <td>2.666e+00</td>
      <td>2.654e+00</td>
      <td>4.641e+00</td>
      <td>3.066e+00</td>
    </tr>
    <tr>
      <th>100000000</th>
      <td>3.740e+01</td>
      <td>3.695e+01</td>
      <td>7.699e+01</td>
      <td>4.161e+01</td>
    </tr>
    <tr>
      <th>1000000000</th>
      <td>4.547e+02</td>
      <td>4.536e+02</td>
      <td>1.059e+03</td>
      <td>4.142e+02</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ax</span> <span class="o">=</span> <span class="n">t_df</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">loglog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">markers</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">v</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">^</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">s</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">p</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">h</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">X</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_lines</span><span class="p">()):</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">markers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">line</span><span class="p">.</span><span class="nf">set_marker</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Timing comparison between Cython and NumPy heapsort</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Array length (log scale)</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Elapsed_time [s] (log scale)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-04-26_01/output_31_0.png" alt="Timings" />
</p>

<h2 id="reference">Reference</h2>

<p>[1] William H. Press, Saul A. Teukolsky, William T. Vetterling, and Brian P. Flannery. 1992. <em>Numerical recipes in C (2nd ed.): the art of scientific computing.</em> Cambridge University Press, USA.</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://aetperf-github-io-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
