<p><strong>Updated</strong> September 26, 2022 bugfix</p>

<p>The goal of this Python notebook is to download and prepare a suite of benchmark networks for some shortest path algorithms. We would like to experiment with some simple directed graphs with non-negative weights. We are specially interested in road networks.</p>

<p>The files are available on the Universita Di Roma website. It was created for the 9th <a href="http://dimacs.rutgers.edu/">DIMACS</a> implementation challenge : <a href="http://www.diag.uniroma1.it/challenge9/"><em>Implementation Challenge about Shortest Paths</em></a>. This challenge dates back to 2006, but the files are still there. Here is the download web page : <a href="http://www.diag.uniroma1.it//challenge9/download.shtml">http://www.diag.uniroma1.it//challenge9/download.shtml</a></p>

<p>The networks correspond to different parts of the USA road network, with various region sizes. Here are the different network names, from smaller to larger:</p>
<ul>
  <li>NY :  New York</li>
  <li>BAY : Bay area</li>
  <li>COL : Colorado</li>
  <li>FLA : Florida</li>
  <li>NW :  North West</li>
  <li>NE :  North East</li>
  <li>CAL :  Califorinia</li>
  <li>LKS : Great Lakes</li>
  <li>E : Eastern region</li>
  <li>W : Western region</li>
  <li>CTR : Central region</li>
  <li>USA : contiguous United States</li>
</ul>

<p>There is an interesting warning on the download page :</p>
<blockquote>
  <p>Known issues: the data has numerous errors, in particular gaps in major highways and bridges. This may result in routes that are very different from real-life ones. One should take this into consideration when experimenting with the data.</p>
</blockquote>

<p>This does not really matter to us because the plan is to implement a shortest path algorithm in Python/Cython and to compare various implementations, but not to find realistic routes.</p>

<p>The networks are available as compressed text files. So here are the very simple steps followed in this notebook:</p>

<ol>
  <li>create a folder structure</li>
  <li>download the compressed network files</li>
  <li>uncompress them with <em>gzip</em></li>
  <li>Create a function to load the edges into a <em>Pandas</em> dataframe</li>
  <li>Create a function to load the node coordinates into a <em>Pandas</em> dataframe</li>
  <li>Save the networks into <em>parquet</em> files</li>
  <li>Query the <em>parquet</em> files with <em>DuckDB</em></li>
  <li>Plot the networks with <em>Datashader</em></li>
</ol>

<h2 id="imports">Imports</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">gzip</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">shutil</span>

<span class="kn">import</span> <span class="n">datashader</span> <span class="k">as</span> <span class="n">ds</span>
<span class="kn">from</span> <span class="n">datashader.bundling</span> <span class="kn">import</span> <span class="n">connect_edges</span>
<span class="kn">import</span> <span class="n">datashader.transfer_functions</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="n">duckdb</span>
<span class="kn">import</span> <span class="n">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">wget</span>

<span class="n">DATA_DIR_ROOT_PATH</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/home/francois/Data/Disk_1/</span><span class="sh">"</span>  <span class="c1"># root data dir
</span></code></pre></div></div>

<p>Package versions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Python    : 3.10.6
datashader: 0.14.2
duckdb    : 0.5.0
geopandas : 0.11.1
numpy     : 1.22.4
pandas    : 1.4.4
pyarrow   : 9.0.0
pygeos    : 0.13
wget      : 3.2
</code></pre></div></div>

<h2 id="create-a-folder-structure">Create a folder structure</h2>

<p>We start by creating a main directory <code class="language-plaintext highlighter-rouge">DIMACS_road_networks</code>, and then one directory per network.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DATA_DIR_ROOT_PATH</span><span class="p">,</span> <span class="sh">"</span><span class="s">DIMACS_road_networks</span><span class="sh">"</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">data_dir_path</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">data_dir_path</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">BAY</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">COL</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FLA</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">NW</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">NE</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">CAL</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LKS</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">E</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">W</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">CTR</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">USA</span><span class="sh">"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">network_dir_paths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">network_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">network_dir_path</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">network_dir_path</span><span class="p">)</span>
    <span class="n">network_dir_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">network_dir_path</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">tree</span> <span class="o">-</span><span class="n">d</span> <span class="p">{</span><span class="n">data_dir_path</span><span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/francois/Data/Disk_1/DIMACS_road_networks
├── BAY
├── CAL
├── COL
├── CTR
├── E
├── FLA
├── LKS
├── NE
├── NW
├── NY
├── USA
└── W

12 directories
</code></pre></div></div>

<h2 id="download-the-compressed-network-files">Download the compressed network files</h2>

<p>Three types of files are available from the DIMACS challenge web site:</p>
<ul>
  <li><strong>Distance graph</strong>: edges with distance weight</li>
  <li><strong>Travel time graph</strong>: edges with travel time weight</li>
  <li><strong>Coordinates</strong>: node coordinates (latitude, longitude)</li>
</ul>

<p>However, we are only going to download the coordinates and travel time graph files in the present notebook. We only require one type of edge weight in order run shortest path algorithms. So between <code class="language-plaintext highlighter-rouge">weight=distance</code> or <code class="language-plaintext highlighter-rouge">weight=travel_time</code>, we chose the latter.</p>

<p>The file URL has a neat pattern.</p>
<ul>
  <li>travel time graph : <code class="language-plaintext highlighter-rouge">http://www.diag.uniroma1.it//challenge9/data/USA-road-t/USA-road-t.XXX.gr.gz</code></li>
  <li>coordinates : <code class="language-plaintext highlighter-rouge">http://www.diag.uniroma1.it//challenge9/data/USA-road-d/USA-road-d.XXX.co.gz</code></li>
</ul>

<p>where <code class="language-plaintext highlighter-rouge">XXX</code> is the network name. So we download each of these files with <code class="language-plaintext highlighter-rouge">wget</code> and save them in the respective network folder.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">travel_time_graph_file_paths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">coordinates_file_paths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>

    <span class="c1"># travel time graph
</span>    <span class="n">travel_time_graph_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">http://www.diag.uniroma1.it//challenge9/data/USA-road-t/USA-road-t.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.gr.gz</span><span class="sh">"</span>
    <span class="n">travel_time_graph_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span>
        <span class="n">network_dir_paths</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="sa">f</span><span class="sh">"</span><span class="s">USA-road-t.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.gr.gz</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">travel_time_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">travel_time_graph_file_path</span>

    <span class="c1"># coordinates
</span>    <span class="n">coordinates_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">http://www.diag.uniroma1.it//challenge9/data/USA-road-d/USA-road-d.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.co.gz</span><span class="sh">"</span>
    <span class="n">coordinates_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span>
        <span class="n">network_dir_paths</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="sa">f</span><span class="sh">"</span><span class="s">USA-road-d.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.co.gz</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">coordinates_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates_file_path</span>

    <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">travel_time_graph_file_path</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">travel_time_graph_file_path</span><span class="p">.</span><span class="nf">removesuffix</span><span class="p">(</span><span class="sh">"</span><span class="s">.gz</span><span class="sh">"</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="n">wget</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">travel_time_graph_url</span><span class="p">,</span> <span class="n">travel_time_graph_file_path</span><span class="p">)</span>
    <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">coordinates_file_path</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">coordinates_file_path</span><span class="p">.</span><span class="nf">removesuffix</span><span class="p">(</span><span class="sh">"</span><span class="s">.gz</span><span class="sh">"</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="n">wget</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">coordinates_url</span><span class="p">,</span> <span class="n">coordinates_file_path</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="uncompress-the-network-files-with-gzip">Uncompress the network files with <em>gzip</em></h2>

<p>We first create a small function that is looking for a zipped file. If found, the zipped file is uncompressed and removed.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">extract_and_cleanup</span><span class="p">(</span><span class="n">file_path_gz</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path_gz</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.gz</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">file_path_gz</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                <span class="n">shutil</span><span class="p">.</span><span class="nf">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">file_path_gz</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">file_path</span>
</code></pre></div></div>

<p>Now we call the above function <code class="language-plaintext highlighter-rouge">extract_and_cleanup</code> for each node and edge file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>

    <span class="c1"># travel time graph
</span>    <span class="n">file_path_gz</span> <span class="o">=</span> <span class="n">travel_time_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="nf">extract_and_cleanup</span><span class="p">(</span><span class="n">file_path_gz</span><span class="p">)</span>
    <span class="n">travel_time_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>

    <span class="c1"># coordinates
</span>    <span class="n">file_path_gz</span> <span class="o">=</span> <span class="n">coordinates_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="nf">extract_and_cleanup</span><span class="p">(</span><span class="n">file_path_gz</span><span class="p">)</span>
    <span class="n">coordinates_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>
</code></pre></div></div>

<h2 id="create-a-function-to-load-the-edges-into-a-pandas-dataframe">Create a function to load the edges into a <em>Pandas</em> dataframe</h2>

<p>Let’s have a look at one of the edge file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">10</span> <span class="p">{</span><span class="n">travel_time_graph_file_paths</span><span class="p">[</span><span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">]}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c 9th DIMACS Implementation Challenge: Shortest Paths
c http://www.dis.uniroma1.it/~challenge9
c TIGER/Line graph USA-road-t.NY
c
p sp 264346 733846
c graph contains 264346 nodes and 733846 arcs
c
a 1 2 2008
a 2 1 2008
a 3 4 395
</code></pre></div></div>

<p>So we need to skip the header lines, starting either with <code class="language-plaintext highlighter-rouge">c</code> or <code class="language-plaintext highlighter-rouge">p</code>. Then, on each edge line, we have the letter <code class="language-plaintext highlighter-rouge">a</code>, the <em>source</em> node index, the <em>target</em> node index and edge travel time. The edge weight has an <code class="language-plaintext highlighter-rouge">int</code> type here and we do not know the time unit. We assume that it corresponds to hundreds of seconds. This also does not matter regarding the comparison of various shortest path implementations.</p>

<p>So once the file is loaded with <code class="language-plaintext highlighter-rouge">pandas.read_csv</code>, we perform a few transformation steps:</p>
<ul>
  <li>set the weight column to <code class="language-plaintext highlighter-rouge">float</code> type, and convert the weight from hundreds of seconds to seconds</li>
  <li>remove parallel edges by keeping a single edge with the <em>min</em> weight</li>
  <li>remove loops, if there is any</li>
  <li>shift the source and target indices by -1 in order to be 0-based</li>
</ul>

<p>The point of removing parallel arcs, is to get a simple directed graphs, that we can represent with an adjacency matrix in a sparse format. Loops could be described in an adjacency matrix but they would be completely useless regarding shortest paths, the edge weights being non-negative.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_travel_time_graph</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>

    <span class="c1"># read the header
</span>    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">(</span><span class="mi">10_000</span><span class="p">)</span>
    <span class="n">header_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">header_size</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">p</span><span class="sh">"</span><span class="p">):</span>
            <span class="c1"># we read the edge count from the header
</span>            <span class="n">edge_count</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">header_size</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">break</span>

    <span class="c1"># read the data
</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span>
        <span class="n">file_path</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">weight</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">weight</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">skiprows</span><span class="o">=</span><span class="n">header_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">edge_count</span>

    <span class="c1"># data preparation and assertions
</span>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">df</span><span class="p">.</span><span class="nf">isna</span><span class="p">().</span><span class="nf">any</span><span class="p">().</span><span class="nf">any</span><span class="p">()</span>  <span class="c1"># no missing values
</span>    <span class="n">df</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">weight</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>  <span class="c1"># convert to float type
</span>    <span class="n">df</span><span class="p">.</span><span class="n">weight</span> <span class="o">*=</span> <span class="mf">0.01</span>  <span class="c1"># convert to seconds
</span>    <span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">weight</span><span class="p">.</span><span class="nf">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.0</span>  <span class="c1"># make sure travel times are non-negative
</span>    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">min</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># remove parallel edges and keep the one with shortest weight
</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">]]</span>  <span class="c1"># remove loops
</span>    <span class="n">df</span><span class="p">[[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">]]</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># switch to 0-based indices
</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<p>We can try <code class="language-plaintext highlighter-rouge">read_travel_time_graph</code> on the NY network file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file_path</span> <span class="o">=</span> <span class="n">travel_time_graph_file_paths</span><span class="p">[</span><span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">]</span>
<span class="n">edges_df</span> <span class="o">=</span> <span class="nf">read_travel_time_graph</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">edges_df</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>source</th>
      <th>target</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>20.08</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>11</td>
      <td>21.05</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1362</td>
      <td>60.70</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="create-a-function-to-load-the-node-coordinates-into-a-pandas-dataframe">Create a function to load the node coordinates into a Pandas dataframe</h2>

<p>The node coordinate files are similar to the edge files:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">10</span> <span class="p">{</span><span class="n">coordinates_file_paths</span><span class="p">[</span><span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">]}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c 9th DIMACS Implementation Challenge: Shortest Paths
c http://www.dis.uniroma1.it/~challenge9
c TIGER/Line nodes coords for graph USA-road-d.NY
c
p aux sp co 264346
c graph contains 264346 nodes
c
v 1 -73530767 41085396
v 2 -73530538 41086098
v 3 -73519366 41048796
</code></pre></div></div>

<p>We also need to skip the header lines, starting either with <code class="language-plaintext highlighter-rouge">c</code> or <code class="language-plaintext highlighter-rouge">p</code>. Then, on each edge line, we have the letter <code class="language-plaintext highlighter-rouge">v</code>, the node index, the longitude and latitude. From what I understand, the coordinates are expressed in WGS 84, but as <code class="language-plaintext highlighter-rouge">int</code> type, in millionth of degrees. So we divide the <code class="language-plaintext highlighter-rouge">int</code> longitude and latitude numbers by a million to obtain the coordinates in degrees.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_coords</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">):</span>

    <span class="c1"># read the header
</span>    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">(</span><span class="mi">10_000</span><span class="p">)</span>
    <span class="n">header_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">header_size</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">p</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">vertex_count</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">v</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">header_size</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">break</span>

    <span class="c1"># read the data
</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span>
        <span class="n">file_path</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">v</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lng</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lng</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">skiprows</span><span class="o">=</span><span class="n">header_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># 0-based indices
</span>    <span class="n">df</span><span class="p">[[</span><span class="sh">"</span><span class="s">lng</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">]]</span> <span class="o">/=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>  <span class="c1"># convert the coordinates to degrees
</span>
    <span class="k">if</span> <span class="n">epsg</span> <span class="o">!=</span> <span class="mi">4326</span><span class="p">:</span>

        <span class="n">gpd</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">use_pygeos</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># load the vertices into a geodataframe
</span>        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="p">.</span><span class="nf">points_from_xy</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">lng</span><span class="p">,</span> <span class="n">df</span><span class="p">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="sh">"</span><span class="s">EPSG:4326</span><span class="sh">"</span>  <span class="c1"># WGS 84
</span>        <span class="p">)</span>
        <span class="n">gdf</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">"</span><span class="s">lng</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gdf</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">nodes_gs</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">.</span><span class="n">geometry</span>
        <span class="n">nodes_gs</span> <span class="o">=</span> <span class="n">nodes_gs</span><span class="p">.</span><span class="nf">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="n">epsg</span><span class="p">)</span>
        <span class="n">nodes_gdf</span> <span class="o">=</span> <span class="n">nodes_gs</span><span class="p">.</span><span class="nf">to_frame</span><span class="p">(</span><span class="sh">"</span><span class="s">geometry</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">nodes_gdf</span><span class="p">[</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes_gdf</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">x</span>
        <span class="n">nodes_gdf</span><span class="p">[</span><span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes_gdf</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">y</span>
        <span class="n">nodes_df</span> <span class="o">=</span> <span class="n">nodes_gdf</span><span class="p">[[</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">]]</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">nodes_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">lng</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">nodes_df</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">nodes_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">vertex_count</span>

    <span class="k">return</span> <span class="n">nodes_df</span>
</code></pre></div></div>

<p>Let’s run <code class="language-plaintext highlighter-rouge">read_coords</code> on the NY network file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file_path</span> <span class="o">=</span> <span class="n">coordinates_file_paths</span><span class="p">[</span><span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">]</span>
<span class="n">nodes_df</span> <span class="o">=</span> <span class="nf">read_coords</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">nodes_df</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>x</th>
      <th>y</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-73.530767</td>
      <td>41.085396</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-73.530538</td>
      <td>41.086098</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-73.519366</td>
      <td>41.048796</td>
    </tr>
  </tbody>
</table>
</div>

<p>We added an argument <code class="language-plaintext highlighter-rouge">epsg</code> with a target CRS. This is, for the case where we would like to use a different CRS than <a href="https://epsg.io/4326">EPSG:4326</a>. <a href="https://geopandas.org/en/stable/">GeoPandas</a> is used to transform the data in that case.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nodes_df</span> <span class="o">=</span> <span class="nf">read_coords</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>
<span class="n">nodes_df</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>x</th>
      <th>y</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-8.185408e+06</td>
      <td>5.024946e+06</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-8.185382e+06</td>
      <td>5.025049e+06</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-8.184138e+06</td>
      <td>5.019542e+06</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="save-the-networks-into-parquet-files">Save the networks into <em>parquet</em> files</h2>

<p>Now we call both functions, <code class="language-plaintext highlighter-rouge">read_travel_time_graph</code> and <code class="language-plaintext highlighter-rouge">read_coords</code>, for all the networks and write the corresponding dataframes as <a href="https://parquet.apache.org/"><em>parquet</em></a> files.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parquet_tt_file_paths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">travel_time_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">parquet_tt_file_path</span> <span class="o">=</span> <span class="n">file_path</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.parquet</span><span class="sh">"</span>
    <span class="n">parquet_tt_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parquet_tt_file_path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">parquet_tt_file_path</span><span class="p">):</span>
        <span class="n">edges_df</span> <span class="o">=</span> <span class="nf">read_travel_time_graph</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">edges_df</span><span class="p">.</span><span class="nf">to_parquet</span><span class="p">(</span><span class="n">parquet_tt_file_path</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parquet_coord_file_paths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">coordinates_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">parquet_coord_file_path</span> <span class="o">=</span> <span class="n">file_path</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.parquet</span><span class="sh">"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">parquet_coord_file_path</span><span class="p">):</span>
        <span class="n">nodes_df</span> <span class="o">=</span> <span class="nf">read_coords</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">nodes_df</span><span class="p">.</span><span class="nf">to_parquet</span><span class="p">(</span><span class="n">parquet_coord_file_path</span><span class="p">)</span>
    <span class="n">parquet_coord_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parquet_coord_file_path</span>
</code></pre></div></div>

<p>We now have all the <em>parquet</em> files ready for use on the disk!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">tree</span> <span class="o">-</span><span class="n">P</span> <span class="sh">'</span><span class="s">*.parquet</span><span class="sh">'</span> <span class="p">{</span><span class="n">data_dir_path</span><span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/francois/Data/Disk_1/DIMACS_road_networks
├── BAY
│   ├── USA-road-d.BAY.co.parquet
│   └── USA-road-t.BAY.gr.parquet
├── CAL
│   ├── USA-road-d.CAL.co.parquet
│   └── USA-road-t.CAL.gr.parquet
├── COL
│   ├── USA-road-d.COL.co.parquet
│   └── USA-road-t.COL.gr.parquet
├── CTR
│   ├── USA-road-d.CTR.co.parquet
│   └── USA-road-t.CTR.gr.parquet
├── E
│   ├── USA-road-d.E.co.parquet
│   └── USA-road-t.E.gr.parquet
├── FLA
│   ├── USA-road-d.FLA.co.parquet
│   └── USA-road-t.FLA.gr.parquet
├── LKS
│   ├── USA-road-d.LKS.co.parquet
│   └── USA-road-t.LKS.gr.parquet
├── NE
│   ├── USA-road-d.NE.co.parquet
│   └── USA-road-t.NE.gr.parquet
├── NW
│   ├── USA-road-d.NW.co.parquet
│   └── USA-road-t.NW.gr.parquet
├── NY
│   ├── USA-road-d.NY.co.parquet
│   └── USA-road-t.NY.gr.parquet
├── USA
│   ├── USA-road-d.USA.co.parquet
│   └── USA-road-t.USA.gr.parquet
└── W
    ├── USA-road-d.W.co.parquet
    └── USA-road-t.W.gr.parquet

12 directories, 24 files
</code></pre></div></div>

<h2 id="query-the-parquet-files-with-duckdb">Query the <em>parquet</em> files with <em>DuckDB</em></h2>

<p>Although we could have done it earlier when we had the dataframes in our hands, we are now going to perform some basic analysis of the networks. The motivation is to clearly separate the different steps.</p>

<p>We want to count the number of edges and vertices in each network, from the <em>parquet</em> files, without loading all the data into memory, and rather in an efficient way. We are going to compute these network features using some SQL, with <a href="https://duckdb.org/">DuckDB</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">network_info</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">parquet_tt_file_path</span> <span class="o">=</span> <span class="n">parquet_tt_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">SELECT COUNT(*), MAX(source), MAX(target) FROM parquet_scan(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_tt_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">)</span><span class="sh">"""</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">edge_count</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vertex_count</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
        WITH edges AS (SELECT
            source,
            target 
        FROM
            parquet_scan(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_tt_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">)) 
        SELECT 
            COUNT(DISTINCT node) 
        FROM
            (     SELECT
                source AS node     
            FROM
                edges     
            UNION ALL     
                  SELECT
                target AS node     
            FROM
                edges       
        )</span><span class="sh">"""</span>
    <span class="n">used_vertices</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mean_degree</span> <span class="o">=</span> <span class="n">edge_count</span> <span class="o">/</span> <span class="n">used_vertices</span>
    <span class="n">network_info</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">:</span> <span class="n">vertex_count</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">used_vertices</span><span class="sh">"</span><span class="p">:</span> <span class="n">used_vertices</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">:</span> <span class="n">edge_count</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mean_degree</span><span class="sh">"</span><span class="p">:</span> <span class="n">mean_degree</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 1min 16s, sys: 3.96 s, total: 1min 20s
Wall time: 43.6 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">network_info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">network_info</span><span class="p">).</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
<span class="n">network_info_df</span> <span class="o">=</span> <span class="n">network_info_df</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">])</span>
<span class="n">pd</span><span class="p">.</span><span class="nf">set_option</span><span class="p">(</span><span class="sh">"</span><span class="s">display.precision</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">network_info_df</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>vertex_count</th>
      <th>used_vertices</th>
      <th>edge_count</th>
      <th>mean_degree</th>
    </tr>
    <tr>
      <th>name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NY</th>
      <td>264346</td>
      <td>264346</td>
      <td>730100</td>
      <td>2.76</td>
    </tr>
    <tr>
      <th>BAY</th>
      <td>321270</td>
      <td>321270</td>
      <td>794830</td>
      <td>2.47</td>
    </tr>
    <tr>
      <th>COL</th>
      <td>435666</td>
      <td>435666</td>
      <td>1042400</td>
      <td>2.39</td>
    </tr>
    <tr>
      <th>FLA</th>
      <td>1070376</td>
      <td>1070376</td>
      <td>2687902</td>
      <td>2.51</td>
    </tr>
    <tr>
      <th>NW</th>
      <td>1207945</td>
      <td>1207945</td>
      <td>2820774</td>
      <td>2.34</td>
    </tr>
    <tr>
      <th>NE</th>
      <td>1524453</td>
      <td>1524453</td>
      <td>3868020</td>
      <td>2.54</td>
    </tr>
    <tr>
      <th>CAL</th>
      <td>1890815</td>
      <td>1890815</td>
      <td>4630444</td>
      <td>2.45</td>
    </tr>
    <tr>
      <th>LKS</th>
      <td>2758119</td>
      <td>2758119</td>
      <td>6794808</td>
      <td>2.46</td>
    </tr>
    <tr>
      <th>E</th>
      <td>3598623</td>
      <td>3598623</td>
      <td>8708058</td>
      <td>2.42</td>
    </tr>
    <tr>
      <th>W</th>
      <td>6262104</td>
      <td>6262104</td>
      <td>15119284</td>
      <td>2.41</td>
    </tr>
    <tr>
      <th>CTR</th>
      <td>14081816</td>
      <td>14081816</td>
      <td>33866826</td>
      <td>2.41</td>
    </tr>
    <tr>
      <th>USA</th>
      <td>23947347</td>
      <td>23947347</td>
      <td>57708624</td>
      <td>2.41</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can observe that all the vertices are actually used in the graph. The mean degree does not vary too much, although it it a little larger in the NY area, which is densely populated.</p>

<h2 id="plot-the-networks-with-datashader">Plot the networks with <em>Datashader</em></h2>

<p>Finally, we are going to plot some of these networks using <a href="https://datashader.org/">Datashader</a>.</p>

<p>But before that, we also want to print a rough approximation of the network width and height. Because we have the coordinates expressed in WGS84, let’s write a small function to compute an approximate distance in meters between two points, given their lat/lon coordinates. This is a straight implementation of <a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine formula</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">haversine_distance</span><span class="p">(</span><span class="n">lon_1</span><span class="p">,</span> <span class="n">lat_1</span><span class="p">,</span> <span class="n">lon_2</span><span class="p">,</span> <span class="n">lat_2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Calculate the distance between two points using their latitude and longitude.</span><span class="sh">"""</span>

    <span class="n">phi_1</span><span class="p">,</span> <span class="n">phi_2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lat_1</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lat_2</span><span class="p">)</span>
    <span class="n">delta_phi</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lat_2</span> <span class="o">-</span> <span class="n">lat_1</span><span class="p">)</span>
    <span class="n">delta_lambda</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lon_2</span> <span class="o">-</span> <span class="n">lon_1</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">delta_phi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">phi_1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">phi_2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">delta_lambda</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">arctan2</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span>

    <span class="n">R</span> <span class="o">=</span> <span class="mf">6.371e6</span>  <span class="c1"># approximate earth radius
</span>    <span class="n">d_m</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">d_m</span>
</code></pre></div></div>

<p>Now the following <code class="language-plaintext highlighter-rouge">load_and_plot</code> function is actually loading the vertex and edge dataframes from the respective <em>parquet</em> files. Then both are used in Datashader’s <code class="language-plaintext highlighter-rouge">connect_edges</code> function. The Datashader part is strongly inspired from its documentation about <a href="https://datashader.org/user_guide/Networks.html">networks</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_and_plot</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">parquet_coord_file_paths</span><span class="p">,</span>
    <span class="n">parquet_tt_file_paths</span><span class="p">,</span>
    <span class="n">network_info_df</span><span class="p">,</span>
    <span class="n">plot_width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># load the network
</span>    <span class="n">parquet_coord_file_path</span> <span class="o">=</span> <span class="n">parquet_coord_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">nodes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_parquet</span><span class="p">(</span><span class="n">parquet_coord_file_path</span><span class="p">)</span>
    <span class="n">parquet_tt_file_path</span> <span class="o">=</span> <span class="n">parquet_tt_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">edges_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_parquet</span><span class="p">(</span><span class="n">parquet_tt_file_path</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">edges_df</span> <span class="o">=</span> <span class="n">edges_df</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uintc</span><span class="p">)</span>

    <span class="c1"># compute the network width and height
</span>    <span class="n">xr</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="n">nodes_df</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="n">nodes_df</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span>
    <span class="n">width_km</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="nf">haversine_distance</span><span class="p">(</span><span class="n">xr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">height_km</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="nf">haversine_distance</span><span class="p">(</span><span class="n">xr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Network : </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">width : </span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">width_km</span><span class="p">))</span><span class="si">:</span><span class="mi">6</span><span class="n">d</span><span class="si">}</span><span class="s"> km, height : </span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">height_km</span><span class="p">))</span><span class="si">:</span><span class="mi">6</span><span class="n">d</span><span class="si">}</span><span class="s"> km</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">vertex_count</span> <span class="o">=</span> <span class="n">network_info_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">edge_count</span> <span class="o">=</span> <span class="n">network_info_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">vertex count : </span><span class="si">{</span><span class="n">vertex_count</span><span class="si">}</span><span class="s">, edge count : </span><span class="si">{</span><span class="n">edge_count</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># plot the network
</span>    <span class="n">edges_ds</span> <span class="o">=</span> <span class="nf">connect_edges</span><span class="p">(</span><span class="n">nodes_df</span><span class="p">,</span> <span class="n">edges_df</span><span class="p">)</span>
    <span class="n">plot_height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">plot_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">yr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">xr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cvsopts</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">plot_height</span><span class="o">=</span><span class="n">plot_height</span><span class="p">,</span> <span class="n">plot_width</span><span class="o">=</span><span class="n">plot_width</span><span class="p">)</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">ds</span><span class="p">.</span><span class="nc">Canvas</span><span class="p">(</span><span class="n">x_range</span><span class="o">=</span><span class="n">xr</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">yr</span><span class="p">,</span> <span class="o">**</span><span class="n">cvsopts</span><span class="p">)</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">spread</span><span class="p">(</span>
        <span class="n">tf</span><span class="p">.</span><span class="nf">shade</span><span class="p">(</span><span class="n">canvas</span><span class="p">.</span><span class="nf">line</span><span class="p">(</span><span class="n">edges_ds</span><span class="p">,</span> <span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="n">ds</span><span class="p">.</span><span class="nf">count</span><span class="p">()),</span> <span class="n">cmap</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">#F03811</span><span class="sh">"</span><span class="p">]),</span>
        <span class="n">px</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ep</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : NY
width :     85 km, height :    111 km
vertex count : 264346, edge count : 730100
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_43_1.png" alt="NY" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">BAY</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : BAY
width :    178 km, height :    222 km
vertex count : 321270, edge count : 794830
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_44_1.png" alt="BAY" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">COL</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : COL
width :    621 km, height :    445 km
vertex count : 435666, edge count : 1042400
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_45_1.png" alt="COL" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">FLA</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : FLA
width :    753 km, height :    680 km
vertex count : 1070376, edge count : 2687902
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_46_1.png" alt="FLA" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">NW</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : NW
width :    720 km, height :    779 km
vertex count : 1207945, edge count : 2820774
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_47_1.png" alt="NW" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">NE</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : NE
width :    520 km, height :    389 km
vertex count : 1524453, edge count : 3868020
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_48_1.png" alt="NE" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">CAL</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : CAL
width :    976 km, height :   1056 km
vertex count : 1890815, edge count : 4630444
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_49_1.png" alt="CAL" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">LKS</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : LKS
width :   1591 km, height :    827 km
vertex count : 2758119, edge count : 6794808
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_50_1.png" alt="LKS" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">E</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : E
width :   1116 km, height :   1543 km
vertex count : 3598623, edge count : 8708058
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_51_1.png" alt="E" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">W</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : W
width :   2422 km, height :   2331 km
vertex count : 6262104, edge count : 15119284
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_52_1.png" alt="W" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">load_and_plot</span><span class="p">(</span><span class="sh">"</span><span class="s">CTR</span><span class="sh">"</span><span class="p">,</span> <span class="n">parquet_coord_file_paths</span><span class="p">,</span> <span class="n">parquet_tt_file_paths</span><span class="p">,</span> <span class="n">network_info_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Network : CTR
width :   2114 km, height :   2669 km
vertex count : 14081816, edge count : 33866826
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-09-22_01/output_53_1.png" alt="CTR" />
</p>

<p>We note that it is hard to distinguish anything in the last plot because of the network large size, with a fixed size plot and a fixed edge width. Also I couldn’t plot the largest one, USA, for some memory reasons.</p>

<p>The networks are now ready to be use by some Shortest Path algorithms, which will be the subject of some future posts.</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://aetperf-github-io-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
