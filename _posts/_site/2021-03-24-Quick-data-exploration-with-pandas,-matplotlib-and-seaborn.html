<p align="center">
  <img width="300" src="https://pandas.pydata.org/static/img/pandas_secondary.svg" alt="Pandas" />
</p>

<p>In this JupyterLab Python notebook we are going to look at the rate of coronavirus (COVID-19) cases in french departments (administrative divisions of France). The data source is the french government’s <a href="https://www.data.gouv.fr/fr/datasets/taux-dincidence-de-lepidemie-de-covid-19/#_">open data</a>.</p>

<p>We are going to perform a few operations, such has filtering some data, pivoting some tables, smoothing time series with a rolling window or plotting an heatmap.</p>

<p><strong>Disclaimer</strong> : although we are going to use some COVID-19 data in this notebook, I want the reader to know that I have ABSOLUTELY no knowledge in epidemiology or any medicine-related subject. The point of this post is not COVID-19 at all but only to show an application of the Python data stack.</p>

<h2 id="imports">Imports</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">colorcet</span> <span class="k">as</span> <span class="n">cc</span>

<span class="n">FS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># figure size
</span></code></pre></div></div>

<h2 id="loading-the-data">Loading the data</h2>

<p>We load the data from an URL straight to a pandas DataFrame:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tests</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">https://www.data.gouv.fr/fr/datasets/r/406c6a23-e283-4300-9484-54e78c8ae675</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tests</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dep</th>
      <th>jour</th>
      <th>P</th>
      <th>T</th>
      <th>cl_age90</th>
      <th>pop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01</td>
      <td>2020-05-13</td>
      <td>0</td>
      <td>16</td>
      <td>9</td>
      <td>83001.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01</td>
      <td>2020-05-13</td>
      <td>1</td>
      <td>17</td>
      <td>19</td>
      <td>84665.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>We have 6 columns here:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">dep</code> : department’s code</li>
  <li><code class="language-plaintext highlighter-rouge">jour</code> :  date</li>
  <li><code class="language-plaintext highlighter-rouge">P</code> : number of positive tests per day</li>
  <li><code class="language-plaintext highlighter-rouge">T</code> : number of tests per day</li>
  <li><code class="language-plaintext highlighter-rouge">cl_age90</code> : age group</li>
  <li><code class="language-plaintext highlighter-rouge">pop</code> : population corresponding to an age group and a department</li>
</ul>

<p>We have 11 age group values, however 0 gathers all age groups:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tests</span><span class="p">.</span><span class="n">cl_age90</span><span class="p">.</span><span class="nf">unique</span><span class="p">().</span><span class="nf">tolist</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[9, 19, 29, 39, 49, 59, 69, 79, 89, 90, 0]
</code></pre></div></div>

<p>For example in Paris, we have:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depnum</span> <span class="o">=</span> <span class="sh">"</span><span class="s">75</span><span class="sh">"</span>
<span class="n">pop_paris</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tests</span><span class="p">[</span><span class="n">tests</span><span class="p">.</span><span class="n">dep</span> <span class="o">==</span> <span class="n">depnum</span><span class="p">][[</span><span class="sh">"</span><span class="s">cl_age90</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">]]</span>
    <span class="p">.</span><span class="nf">drop_duplicates</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">"</span><span class="s">cl_age90</span><span class="sh">"</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">pop_paris</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Population in department </span><span class="si">{</span><span class="n">depnum</span><span class="si">}</span><span class="s"> per age group</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Population</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2021-03-24_01/output_7_0.png" alt="" />
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert </span><span class="p">(</span>
    <span class="n">pop_paris</span><span class="p">[</span><span class="n">pop_paris</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">].</span><span class="nf">sum</span><span class="p">().</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">==</span> <span class="n">pop_paris</span><span class="p">[</span><span class="n">pop_paris</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<p>We start by creating a <code class="language-plaintext highlighter-rouge">DatetimeIndex</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tests</span><span class="p">.</span><span class="n">jour</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">tests</span><span class="p">.</span><span class="n">jour</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">"</span><span class="s">%Y-%m-%d</span><span class="sh">"</span><span class="p">)</span>
<span class="n">tests</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">"</span><span class="s">jour</span><span class="sh">"</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">tests</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Date</span><span class="sh">"</span>
<span class="n">tests</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dep</th>
      <th>P</th>
      <th>T</th>
      <th>cl_age90</th>
      <th>pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-05-13</th>
      <td>01</td>
      <td>0</td>
      <td>16</td>
      <td>9</td>
      <td>83001.0</td>
    </tr>
    <tr>
      <th>2020-05-13</th>
      <td>01</td>
      <td>1</td>
      <td>17</td>
      <td>19</td>
      <td>84665.0</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="covid-19-and-test-rates-in-the-rhône-department">COVID-19 and test rates in the Rhône department</h2>

<p>Now we select a department (Rhône department with code 69):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depnum</span> <span class="o">=</span> <span class="sh">"</span><span class="s">69</span><span class="sh">"</span>
<span class="n">dep_tot</span> <span class="o">=</span> <span class="n">tests</span><span class="p">[(</span><span class="n">tests</span><span class="p">.</span><span class="n">dep</span> <span class="o">==</span> <span class="n">depnum</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tests</span><span class="p">.</span><span class="n">cl_age90</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)].</span><span class="nf">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">dep_tot</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">"</span><span class="s">dep</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cl_age90</span><span class="sh">"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">dep_tot</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>P</th>
      <th>T</th>
      <th>pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-05-13</th>
      <td>20</td>
      <td>1468</td>
      <td>1876051.0</td>
    </tr>
    <tr>
      <th>2020-05-14</th>
      <td>41</td>
      <td>1531</td>
      <td>1876051.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can now compute and plot the COVID-19 rate for all age groups in this department:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">100000</span> <span class="o">*</span> <span class="n">dep_tot</span><span class="p">.</span><span class="n">P</span> <span class="o">/</span> <span class="n">dep_tot</span><span class="p">[</span><span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">])</span>
    <span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">100000</span> <span class="o">*</span> <span class="n">dep_tot</span><span class="p">[</span><span class="sh">"</span><span class="s">T</span><span class="sh">"</span><span class="p">]</span> <span class="o">/</span> <span class="n">dep_tot</span><span class="p">[</span><span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">])</span>
    <span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Daily COVID-19 rate (per 100000) in department </span><span class="si">{</span><span class="n">depnum</span><span class="si">}</span><span class="s"> (log scale)</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">log scale</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">"</span><span class="s">Daily COVID-19 rate</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Daily test rate</span><span class="sh">"</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">autoscale</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2021-03-24_01/output_14_0.png" alt="" />
</p>

<p>We can also show the positivity rate:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dep_tot</span><span class="p">.</span><span class="n">P</span> <span class="o">/</span> <span class="n">dep_tot</span><span class="p">[</span><span class="sh">"</span><span class="s">T</span><span class="sh">"</span><span class="p">]).</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Positivity rate in department </span><span class="si">{</span><span class="n">depnum</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Positivity rate (%)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">autoscale</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2021-03-24_01/output_16_0.png" alt="" />
</p>

<h2 id="departement-with-the-worst-covid-19-rate">Departement with the worst COVID-19 rate</h2>

<p>First we need to select departments with a rather large population size (at least 50000 inhabitants for example) in order to compute a significative rate per 100000. Here is the population per department:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pop</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tests</span><span class="p">[</span><span class="n">tests</span><span class="p">.</span><span class="n">cl_age90</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][[</span><span class="sh">"</span><span class="s">dep</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">]]</span>
    <span class="p">.</span><span class="nf">drop_duplicates</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">pop</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dep</th>
      <th>pop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>975</td>
      <td>5997.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>977</td>
      <td>9961.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>978</td>
      <td>35334.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>48</td>
      <td>76286.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>23</td>
      <td>116270.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>We create a list of departments with population above a threshold value:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pop_th</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">large_deps</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="n">pop</span><span class="p">[</span><span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pop_th</span><span class="p">].</span><span class="n">dep</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()</span>
</code></pre></div></div>

<p>Now we pivot the table such that each column corresponds to a department:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cr_alldep</span> <span class="o">=</span> <span class="n">tests</span><span class="p">[</span><span class="n">tests</span><span class="p">.</span><span class="n">cl_age90</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][[</span><span class="sh">"</span><span class="s">dep</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">]]</span>
<span class="n">cr_alldep</span><span class="p">[</span><span class="sh">"</span><span class="s">cr</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span> <span class="o">*</span> <span class="n">cr_alldep</span><span class="p">.</span><span class="n">P</span> <span class="o">/</span> <span class="n">cr_alldep</span><span class="p">[</span><span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">]</span>
<span class="n">cr_alldep</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">cr_alldep</span> <span class="o">=</span> <span class="n">cr_alldep</span><span class="p">.</span><span class="nf">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="sh">"</span><span class="s">dep</span><span class="sh">"</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="sh">"</span><span class="s">cr</span><span class="sh">"</span><span class="p">)</span>
<span class="n">cr_alldep</span> <span class="o">=</span> <span class="n">cr_alldep</span><span class="p">[</span>
    <span class="n">large_deps</span>
<span class="p">]</span>  <span class="c1"># Here we select the largest departments regarding population
</span><span class="n">cr_alldep</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>dep</th>
      <th>48</th>
      <th>23</th>
      <th>...</th>
      <th>75</th>
      <th>59</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-05-13</th>
      <td>0.0</td>
      <td>0.860067</td>
      <td>...</td>
      <td>1.768864</td>
      <td>1.390505</td>
    </tr>
    <tr>
      <th>2020-05-14</th>
      <td>0.0</td>
      <td>0.860067</td>
      <td>...</td>
      <td>2.606747</td>
      <td>1.622255</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 102 columns</p>
</div>

<p>Let’s look at the 5 departments with the highest COVID-19 rate in the most recent days:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_deps</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">deps</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">cr_alldep</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">dropna</span><span class="p">()</span>
    <span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="n">n_deps</span><span class="p">]</span>
    <span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">deps</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['93', '95', '94', '77', '75']
</code></pre></div></div>

<p>We can now plot the evolution of the COVID-19 rate in these 5 most affected departments:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">highest_cr</span> <span class="o">=</span> <span class="n">cr_alldep</span><span class="p">[</span><span class="n">deps</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">highest_cr</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Daily COVID-19 rate (per 100000) in the most affected departments</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">COVID-19 rate</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">autoscale</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2021-03-24_01/output_25_0.png" alt="" />
</p>

<p>Now we are going to focus on the department with highest COVID-19 rate.</p>

<h2 id="heatmap-of-the-covid-19-rate-by-age-group-in-the-most-affected-department">Heatmap of the COVID-19 rate by age group in the most affected department</h2>

<p>We start by pivoting the table such that each column corresponds to an age group:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depnum</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dep_ag</span> <span class="o">=</span> <span class="n">tests</span><span class="p">[(</span><span class="n">tests</span><span class="p">.</span><span class="n">dep</span> <span class="o">==</span> <span class="n">depnum</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tests</span><span class="p">.</span><span class="n">cl_age90</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)].</span><span class="nf">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">dep_ag</span><span class="p">[</span><span class="sh">"</span><span class="s">cr</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span> <span class="o">*</span> <span class="n">dep_ag</span><span class="p">.</span><span class="n">P</span> <span class="o">/</span> <span class="n">dep_ag</span><span class="p">[</span><span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">]</span>
<span class="n">dep_ag</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">"</span><span class="s">dep</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">T</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pop</span><span class="sh">"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">dep_ag</span> <span class="o">=</span> <span class="n">dep_ag</span><span class="p">.</span><span class="nf">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="sh">"</span><span class="s">cl_age90</span><span class="sh">"</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="sh">"</span><span class="s">cr</span><span class="sh">"</span><span class="p">)</span>
<span class="n">dep_ag</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cl_age90</th>
      <th>9</th>
      <th>19</th>
      <td>...</td>
      <th>89</th>
      <th>90</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-05-13</th>
      <td>1.160501</td>
      <td>1.324369</td>
      <td>...</td>
      <td>19.272929</td>
      <td>96.936797</td>
    </tr>
    <tr>
      <th>2020-05-14</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>26.500277</td>
      <td>9.693680</td>
    </tr>
  </tbody>
</table>
</div>

<p>Also, we compute the weekly average and transpose the table:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cr_smooth</span> <span class="o">=</span> <span class="n">dep_ag</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">"</span><span class="s">W</span><span class="sh">"</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="n">T</span>
<span class="n">cr_smooth</span> <span class="o">=</span> <span class="n">cr_smooth</span><span class="p">.</span><span class="nf">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">cr_smooth</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">date</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cr_smooth</span><span class="p">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">cr_smooth</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2020-05-17</th>
      <th>2020-05-24</th>
      <th>...</th>
      <th>2021-03-14</th>
      <th>2021-03-21</th>
    </tr>
    <tr>
      <th>cl_age90</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>90</th>
      <td>23.264831</td>
      <td>24.926605</td>
      <td>...</td>
      <td>54.007644</td>
      <td>74.318211</td>
    </tr>
    <tr>
      <th>89</th>
      <td>12.527404</td>
      <td>7.915667</td>
      <td>...</td>
      <td>60.916221</td>
      <td>63.038538</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 45 columns</p>
</div>

<p>We can now plot the heatmap:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span>
    <span class="n">cr_smooth</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="sh">"</span><span class="s">d</span><span class="sh">"</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cc</span><span class="p">.</span><span class="n">fire</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Daily COVID-19 rate in department </span><span class="si">{</span><span class="n">depnum</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Age group</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="1600" src="/img/2021-03-24_01/output_31_0.png" alt="" />
</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://aetperf-github-io-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
