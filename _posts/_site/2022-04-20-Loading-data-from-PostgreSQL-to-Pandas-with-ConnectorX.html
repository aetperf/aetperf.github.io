<p><a href="https://sfu-db.github.io/connector-x/intro.html">ConnectorX</a> is a library, written in Rust, that enables fast and memory-efficient data loading from various databases to different dataframes. We refer to this interesting <a href="https://wooya.me/files/ConnectorX.pdf">paper</a>, in which the authors provide a detailed analysis of the <code class="language-plaintext highlighter-rouge">pandas.read_sql</code> function:</p>

<p>Wang, Xiaoying, et al. <em>ConnectorX: Accelerating Data Loading From Databases to Dataframes.</em> 2021</p>

<p>This lead to some surprises:</p>

<blockquote>
  <p>A surprising finding is that the majority of the time is actually spent on the client side rather than on the query execution or the data transfer.</p>
</blockquote>

<p>Most of the time is spent on deserialization and conversion to dataframe. So they tried to optimize these two steps, and also implemented an efficient parallelization based on query partitioning.</p>

<p>In the present post, we want to try the different ways, including with ConnectorX, to load some data with Python, from PostgreSQL to Pandas. Here are the different strategies tested:</p>
<ul>
  <li>SQLAlchemy + psycopg2</li>
  <li>SQLAlchemy + psycopg2 by chunks</li>
  <li>pyodbc</li>
  <li>turbodbc + arrow</li>
  <li>ConnectorX + pandas</li>
  <li>ConnectorX + arrow</li>
  <li>ConnectorX + modin</li>
  <li>ConnectorX + dask</li>
  <li>ConnectorX + polars</li>
  <li>ConnectorX + pandas with 2 partitions</li>
  <li>ConnectorX + pandas with 4 partitions</li>
  <li>ConnectorX + pandas with 8 partitions</li>
</ul>

<h2 id="the-data">The Data</h2>

<p>We have a table with fake data, created in Python with the <a href="https://github.com/joke2k/faker">Faker</a> package, and stored as a Pandas dataframe <code class="language-plaintext highlighter-rouge">df</code>. Initially, this table has been loaded into PostgreSQL with the following piece of code, assumine the SQL <code class="language-plaintext highlighter-rouge">engine</code> has also already been created:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sqlalchemy.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Boolean</span><span class="p">,</span>
    <span class="n">Date</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">Float</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">SmallInteger</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">l_name</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">l_job</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">l_email</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">l_company</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">l_industry</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">l_city</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">l_state</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">l_zipcode</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_name</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">job</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_job</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">birthdate</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Date</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">email</span><span class="sh">"</span><span class="p">:</span> <span class="nc">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_email</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">last_connect</span><span class="sh">"</span><span class="p">:</span> <span class="nc">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">company</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_company</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">industry</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_industry</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_city</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">state</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_state</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">zipcode</span><span class="sh">"</span><span class="p">:</span> <span class="nc">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">l_zipcode</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">netNew</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">sales1_rounded</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Integer</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">sales2_decimal</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Float</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">sales2_rounded</span><span class="sh">"</span><span class="p">:</span> <span class="nc">Integer</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">priority</span><span class="sh">"</span><span class="p">:</span> <span class="nc">SmallInteger</span><span class="p">(),</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">.</span><span class="nf">to_sql</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">faker_s1000000i</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">engine</span><span class="p">,</span>
    <span class="n">if_exists</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">index_label</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Here is a SELECT on the table from pgAdmin:</p>

<p align="center">
  <img width="1000" src="/img/2022-04-20_01/faker.png" alt="faker" />
</p>

<p>The table has a million rows and 16 columns. The query used to load the data is basic:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QUERY</span> <span class="o">=</span> <span class="sh">'</span><span class="s">SELECT * FROM </span><span class="sh">"</span><span class="s">faker_s1000000i</span><span class="sh">"'</span>
</code></pre></div></div>

<p>We are going to compare the loading time using different drivers and methods. We do not measure the peak memory, but just the elapsed time for loading the data into Pandas. Database server and client are on the same machine (my laptop).</p>

<h2 id="imports">Imports</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">urllib</span>

<span class="kn">import</span> <span class="n">connectorx</span> <span class="k">as</span> <span class="n">cx</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">psycopg2</span>
<span class="kn">import</span> <span class="n">pyodbc</span>
<span class="kn">import</span> <span class="n">ray</span>
<span class="kn">import</span> <span class="n">turbodbc</span>
<span class="kn">from</span> <span class="n">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">ray</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">ignore_reinit_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Package versions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Python    : 3.9.12
psycopg2  : 2.9.3
sqlalchemy: 1.4.35
numpy     : 1.22.3
ray       : 1.11.0
connectorx: 0.2.5
turbodbc  : 4.5.3
pyodbc    : 4.0.32
pandas    : 1.4.1
</code></pre></div></div>

<h2 id="credentials">Credentials</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pg_username</span> <span class="o">=</span> <span class="sh">"</span><span class="s">****</span><span class="sh">"</span>
<span class="n">pg_password</span> <span class="o">=</span> <span class="sh">"</span><span class="s">****</span><span class="sh">"</span>
<span class="n">pg_server</span> <span class="o">=</span> <span class="sh">"</span><span class="s">localhost</span><span class="sh">"</span>
<span class="n">pg_port</span> <span class="o">=</span> <span class="mi">5432</span>
<span class="n">pg_database</span> <span class="o">=</span> <span class="sh">"</span><span class="s">pgdb</span><span class="sh">"</span>
</code></pre></div></div>

<h2 id="sqlalchemy--psycopg2-sqlalchemy_psychopg2">SQLAlchemy + psycopg2 (<code class="language-plaintext highlighter-rouge">sqlalchemy_psychopg2</code>)</h2>

<p>This is the most common way for loading data from Postgres into Pandas.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connect_string</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">postgresql+psycopg2://</span><span class="si">{</span><span class="n">pg_username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">urllib</span><span class="p">.</span><span class="n">parse</span><span class="p">.</span><span class="nf">quote_plus</span><span class="p">(</span><span class="n">pg_password</span><span class="p">)</span><span class="si">}</span><span class="s">@</span><span class="si">{</span><span class="n">pg_server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">pg_port</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">pg_database</span><span class="si">}</span><span class="sh">"</span>
<span class="n">engine_psycopg2</span> <span class="o">=</span> <span class="nf">create_engine</span><span class="p">(</span><span class="n">connect_string</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="k">with</span> <span class="n">engine_psycopg2</span><span class="p">.</span><span class="nf">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 7.06 s, sys: 755 ms, total: 7.81 s
Wall time: 8.54 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="sqlalchemy--psycopg2-by-chunks-sqlalchemy_psychopg2_chunks">SQLAlchemy + psycopg2 by chunks (<code class="language-plaintext highlighter-rouge">sqlalchemy_psychopg2_chunks</code>)</h2>

<p>Now let’s imagine that we want to reduce the memory usage of the previous process by loading the data by chunks. This code is inspired by the ConnectorX github <a href="https://github.com/sfu-db/connector-x/tree/main/benchmarks">repository</a>, where a lot of usefull benchmark code can be found.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">chunksize</span> <span class="o">=</span> <span class="mi">1_000</span>
<span class="n">engine</span> <span class="o">=</span> <span class="nf">create_engine</span><span class="p">(</span><span class="n">connect_string</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="nf">connect</span><span class="p">().</span><span class="nf">execution_options</span><span class="p">(</span>
    <span class="n">stream_results</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_row_buffer</span><span class="o">=</span><span class="n">chunksize</span>
<span class="p">)</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">):</span>
    <span class="n">dfs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 9.39 s, sys: 428 ms, total: 9.82 s
Wall time: 11 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="pyodbc-pyodbc">pyodbc (<code class="language-plaintext highlighter-rouge">pyodbc</code>)</h2>

<p>The official PostgreSQL ODBC driver is used here with default settings.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connection</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">dsn</span><span class="o">=</span><span class="sh">"</span><span class="s">PostgreSQL</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> UserWarning: pandas only support SQLAlchemy connectable(engine/connection) ordatabase string URI or sqlite3 DBAPI2 connectionother DBAPI2 objects are not tested, please consider using SQLAlchemy
  warnings.warn(


CPU times: user 16.9 s, sys: 723 ms, total: 17.6 s
Wall time: 17.7 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="turbodbc--arrow-turbodbc_arrow">Turbodbc + arrow (<code class="language-plaintext highlighter-rouge">turbodbc_arrow</code>)</h2>

<p>Here we do not use Pandas’<code class="language-plaintext highlighter-rouge">read_sql</code> function but Apache Arrow along with Turbodbc. See this blog post for more details: <a href="https://arrow.apache.org/blog/2017/06/16/turbodbc-arrow/">https://arrow.apache.org/blog/2017/06/16/turbodbc-arrow/</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connection</span> <span class="o">=</span> <span class="n">turbodbc</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">dsn</span><span class="o">=</span><span class="sh">"</span><span class="s">PostgreSQL</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="nf">fetchallarrow</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">to_pandas</span><span class="p">(</span><span class="n">split_blocks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">date_as_object</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 7.17 s, sys: 374 ms, total: 7.55 s
Wall time: 7.8 s
</code></pre></div></div>

<p>The type of the <code class="language-plaintext highlighter-rouge">data</code> returned above by <code class="language-plaintext highlighter-rouge">fetchallarrow()</code> is an Arrow table, this is why it is later converted to a Pandas dataframe.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="connectorx">ConnectorX</h2>

<p>We are going to connect the data source with the following connection string URI and use the <code class="language-plaintext highlighter-rouge">cx.read_sql</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connect_string</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">postgres://</span><span class="si">{</span><span class="n">pg_username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">urllib</span><span class="p">.</span><span class="n">parse</span><span class="p">.</span><span class="nf">quote_plus</span><span class="p">(</span><span class="n">pg_password</span><span class="p">)</span><span class="si">}</span><span class="s">@</span><span class="si">{</span><span class="n">pg_server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">pg_port</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">pg_database</span><span class="si">}</span><span class="sh">"</span>
</code></pre></div></div>

<h3 id="pandas-cx_pandas">Pandas (<code class="language-plaintext highlighter-rouge">cx_pandas</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">pandas</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 3.71 s, sys: 278 ms, total: 3.99 s
Wall time: 3.96 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="arrow-cx_arrow">Arrow (<code class="language-plaintext highlighter-rouge">cx_arrow</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">arrow</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 3.2 s, sys: 237 ms, total: 3.43 s
Wall time: 3.35 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">type</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pyarrow.lib.Table
</code></pre></div></div>

<p>Since the returning type is not a Pandas dataframe but an Arrow table, we need to convert it (and take the conversion time into account):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="nf">to_pandas</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 1.21 s, sys: 209 ms, total: 1.42 s
Wall time: 1.4 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="modin-cx_modin">Modin (<code class="language-plaintext highlighter-rouge">cx_modin</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">modin</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UserWarning: The pandas version installed 1.4.2 does not match the supported pandas version in Modin 1.4.1. This may cause undesired side effects!
UserWarning: Distributing &lt;class 'pandas.core.frame.DataFrame'&gt; object. This may take some time.


CPU times: user 6.09 s, sys: 629 ms, total: 6.72 s
Wall time: 6.78 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>modin.pandas.dataframe.DataFrame
</code></pre></div></div>

<p>Here we need to convert from a Modin to a Pandas dataframe:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">_to_pandas</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 1.28 s, sys: 266 ms, total: 1.55 s
Wall time: 1.53 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="dask-cx_dask">Dask (<code class="language-plaintext highlighter-rouge">cx_dask</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">dask</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 5.4 s, sys: 528 ms, total: 5.92 s
Wall time: 5.88 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dask.dataframe.core.DataFrame
</code></pre></div></div>

<p>Each partition in a Dask DataFrame is a Pandas DataFrame. Since we are presumably using a single partition in the present case, converting to Pandas is almost instentaneous:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">compute</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 1.53 ms, sys: 86 µs, total: 1.62 ms
Wall time: 1.15 ms
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="polars-cx_polars">Polars (<code class="language-plaintext highlighter-rouge">cx_polars</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">polars</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 3.34 s, sys: 255 ms, total: 3.59 s
Wall time: 3.51 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>polars.internals.frame.DataFrame
</code></pre></div></div>

<p>Again, we need to convert from a Polars to a Pandas dataframe :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">to_pandas</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 848 ms, sys: 149 ms, total: 997 ms
Wall time: 982 ms
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="pandas-2-partitions-cx_pandas_2">Pandas 2 partitions (<code class="language-plaintext highlighter-rouge">cx_pandas_2</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">pandas</span><span class="sh">"</span><span class="p">,</span> <span class="n">partition_on</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">,</span> <span class="n">partition_num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 4.77 s, sys: 596 ms, total: 5.37 s
Wall time: 2.88 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="pandas-4-partitions-cx_pandas_4">Pandas 4 partitions (<code class="language-plaintext highlighter-rouge">cx_pandas_4</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">pandas</span><span class="sh">"</span><span class="p">,</span> <span class="n">partition_on</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">,</span> <span class="n">partition_num</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 5.95 s, sys: 657 ms, total: 6.61 s
Wall time: 2.2 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="pandas-8-partitions-cx_pandas_8">Pandas 8 partitions (<code class="language-plaintext highlighter-rouge">cx_pandas_8</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="nf">read_sql</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connect_string</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">QUERY</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="sh">"</span><span class="s">pandas</span><span class="sh">"</span><span class="p">,</span> <span class="n">partition_on</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">,</span> <span class="n">partition_num</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 5.72 s, sys: 689 ms, total: 6.41 s
Wall time: 2.28 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="comparison">Comparison</h2>

<p>We did not include here the code associated with time measurements. Basically, for each strategy, the loading process is repeated 5 times and only the best elapsed time is kept. Here is the resulting table:</p>

<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>read_sql</th>
      <th>to_frame</th>
      <th>total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pyodbc</th>
      <td>17.79901</td>
      <td>0.00000</td>
      <td>17.79901</td>
    </tr>
    <tr>
      <th>sqlalchemy_psycopg2_chunks</th>
      <td>10.87270</td>
      <td>0.00000</td>
      <td>10.87270</td>
    </tr>
    <tr>
      <th>sqlalchemy_psycopg2</th>
      <td>9.14140</td>
      <td>0.00000</td>
      <td>9.14140</td>
    </tr>
    <tr>
      <th>cx_modin</th>
      <td>6.42423</td>
      <td>1.54774</td>
      <td>7.97197</td>
    </tr>
    <tr>
      <th>turbodbc_arrow</th>
      <td>6.36288</td>
      <td>0.96034</td>
      <td>7.32322</td>
    </tr>
    <tr>
      <th>cx_dask</th>
      <td>5.29873</td>
      <td>0.00043</td>
      <td>5.29916</td>
    </tr>
    <tr>
      <th>cx_arrow</th>
      <td>3.16782</td>
      <td>1.11604</td>
      <td>4.28385</td>
    </tr>
    <tr>
      <th>cx_polars</th>
      <td>3.23051</td>
      <td>0.97591</td>
      <td>4.20642</td>
    </tr>
    <tr>
      <th>cx_pandas</th>
      <td>3.95265</td>
      <td>0.00000</td>
      <td>3.95265</td>
    </tr>
    <tr>
      <th>cx_pandas_2</th>
      <td>2.48966</td>
      <td>0.00000</td>
      <td>2.48966</td>
    </tr>
    <tr>
      <th>cx_pandas_8</th>
      <td>2.12081</td>
      <td>0.00000</td>
      <td>2.12081</td>
    </tr>
    <tr>
      <th>cx_pandas_4</th>
      <td>1.93755</td>
      <td>0.00000</td>
      <td>1.93755</td>
    </tr>
  </tbody>
</table>

<p align="center">
  <img width="1000" src="/img/2022-04-20_01/output_92_0.png" alt="Elapsed time" />
</p>

<p><code class="language-plaintext highlighter-rouge">read_sql</code> corrrespond to the elapsed time spent in loading the data into a container, while <code class="language-plaintext highlighter-rouge">to_frame</code> is the elapsed time spent in converting this container into a Pandas dataframe, if necessary.</p>

<p>We can see that ConnectorX is an efficient tool. We did not measure memory efficiency in this post, but it is supposed to be interesting as well. The supported data sources are the following (from the <a href="https://sfu-db.github.io/connector-x/intro.html">documentation</a>): Postgres, Mysql, Mariadb (through mysql protocol), Sqlite, Redshift (through postgres protocol), Clickhouse (through mysql protocol), SQL Server, Azure SQL Database (through mssql protocol), Oracle. It would be great if more data sources could be supported, such as SAP Hana for example!</p>

<p>Although we loaded the data into a Pandas dataframe in the present post, we could also imagine to use ConnectorX along with <a href="https://github.com/pola-rs/polars">Polars</a> dataframes to perform some data analysis tasks.</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://aetperf-github-io-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
