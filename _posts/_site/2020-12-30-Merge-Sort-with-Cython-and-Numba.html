<p>In this post, we present an implementation of the classic <em>merge sort</em> algorithm in Python on NumPy arrays, and make it run reasonably “fast” using <a href="https://cython.org/">Cython</a> and <a href="https://numba.pydata.org/">Numba</a>. We are going to compare the run time with the <a href="https://numpy.org/doc/stable/reference/generated/numpy.sort.html"><code class="language-plaintext highlighter-rouge">numpy.sort(kind='mergesort')</code></a> implementation (<a href="https://github.com/numpy/numpy/blob/master/numpy/core/src/npysort/mergesort.c.src">in C</a>). We already applied both tools to <em>insertion sort</em> in a previous <a href="https://aetperf.github.io/2020/04/04/Cython-and-Numba-applied-to-simple-algorithm.html">post</a>. Let’s start by briefly describing the <em>merge sort</em> algorithm.</p>

<p align="center">
  <img width="400" src="/img/2020-12-30_01/out.gif" alt="Timings" />
</p>

<h2 id="merge-sort">Merge sort</h2>

<p>Here is the main idea of <em>merge sort</em> (from <a href="https://en.wikipedia.org/wiki/Merge_sort">wikipedia</a>):</p>

<blockquote>
  <p>Conceptually, a merge sort works as follows:</p>
  <ul>
    <li>Divide the unsorted list into $n$ sublists, each containing one element (a list of one element is considered sorted).</li>
    <li>Repeatedly merge sublists to produce new sorted sublists until there is only one sublist remaining. This will be the sorted list.</li>
  </ul>
</blockquote>

<p align="center">
  <img width="400" src="/img/2020-12-30_01/margesort.png" alt="marge sort" />
</p>

<p>The performance of <em>merge sort</em> is $O(n\log{}n)$ independently of the input order: worst case and average case have the same complexities. We refer to any classic book about algorithms to get more theoretical and practical insights about this algorithm.</p>

<h3 id="top-down-implementation">Top-down implementation</h3>

<p>Here we are going to implement a top-down version of the algorithm for arrays: it is a divide-and-conquer recursive approach that we can describe with the following simplified code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mergesort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="nf">int</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nf">mergessort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>  <span class="c1"># sort the left sub-array recursively
</span>        <span class="nf">mergesort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>  <span class="c1"># sort the right sub-array recursively
</span>        <span class="nf">merge</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        
<span class="nf">mergesort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">merge</code> part consists in sorting two sorted contiguous chunks of arrays.</p>

<h3 id="implementation-optimizations">Implementation optimizations</h3>

<p>An additional storage is used during the <code class="language-plaintext highlighter-rouge">merge</code> step, which size is of the order of $n$. This also implies copying back the merged list from the auxiliary array(s) back to $A$, which has a cost. It is possible to implement the algorithm without copying, which is what we chose to do in the following. As explained by Robert Sedgewick in [1]:</p>

<blockquote>
  <p>To do so, we arrange the recursive calls such that the computation switches the roles of the input array and the auxiliary array at each level.</p>
</blockquote>

<p>Here are the optimizations performed in the following implementation:</p>
<ul>
  <li>Eliminate the copy to the auxiliary array (reducing the cost of copying).</li>
  <li>Use an in-place sorting algorithm (<code class="language-plaintext highlighter-rouge">insertion sort</code>) for small subarrays (length smaller than a constant <code class="language-plaintext highlighter-rouge">SMALL_MERGESORT=40</code>). This may be referred to as <em>tiled merge sort</em>.</li>
  <li>Stop if already sorted (test if the array is already in order before merging : <code class="language-plaintext highlighter-rouge">A[mid] &lt;= A[mid + 1]</code>).</li>
</ul>

<p>[1] Robert Sedgewick. <em>Algorithms in C: Parts 1-4, Fundamentals, Data Structures, Sorting, and Searching (3rd. ed.)</em>. Addison-Wesley Longman Publishing Co., Inc., USA. 1997.</p>

<h2 id="imports">Imports</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">perfplot</span>
<span class="kn">from</span> <span class="n">numba</span> <span class="kn">import</span> <span class="n">jit</span>

<span class="o">%</span><span class="n">load_ext</span> <span class="n">Cython</span>

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="mi">124</span><span class="p">)</span>  <span class="c1"># Just a habit
</span></code></pre></div></div>

<p>Here are the package versions:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Python    : 3.8.6
numpy     : 1.19.4
perfplot  : 0.8.1
cython    : 0.29.21
numba     : 0.52.0
matplotlib: 3.3.3
</code></pre></div></div>

<h2 id="test-array">Test array</h2>

<p>We create a small NumPy <code class="language-plaintext highlighter-rouge">int64</code> array in order to test the different implementations.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">A</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([4558, 4764, 8327, 9154,  681])
</code></pre></div></div>

<h2 id="cython-implementation">Cython implementation</h2>

<p>The Cython implementation can only sort NumPy <code class="language-plaintext highlighter-rouge">int64</code> arrays. The functions should be duplicated and specialized to each supported type (e.g. <code class="language-plaintext highlighter-rouge">float64</code>).</p>

<div class="language-cython highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">cython</span> <span class="o">--</span><span class="nb">compile</span><span class="o">-</span><span class="n">args</span><span class="o">=-</span><span class="n">Ofast</span>

<span class="kn">import</span> <span class="n">cython</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">cnp</span>

<span class="k">ctypedef</span> <span class="n">cnp</span><span class="p">.</span><span class="n">int64_t</span> <span class="n">stype</span>

<span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="n">SMALL_MERGESORT_CYTHON</span> <span class="o">=</span> <span class="mi">40</span>

<span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.initializedcheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.binding</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">merge_cython</span><span class="p">(</span>
    <span class="kt">stype</span><span class="p">[:]</span> <span class="n">A</span><span class="p">,</span> 
    <span class="kt">stype</span><span class="p">[:]</span> <span class="n">Aux</span><span class="p">,</span> 
    <span class="kt">Py_ssize_t</span> <span class="n">lo</span><span class="p">,</span> 
    <span class="kt">Py_ssize_t</span> <span class="n">mid</span><span class="p">,</span> 
    <span class="kt">Py_ssize_t</span> <span class="n">hi</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>

    <span class="k">cdef</span><span class="p">:</span>
        <span class="kt">Py_ssize_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">lo</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">mid</span><span class="p">:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">hi</span><span class="p">:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.initializedcheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.binding</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">insertion_sort_cython</span><span class="p">(</span>
    <span class="kt">stype</span><span class="p">[:]</span> <span class="n">A</span><span class="p">,</span> 
    <span class="kt">Py_ssize_t</span> <span class="n">lo</span><span class="p">,</span> 
    <span class="kt">Py_ssize_t</span> <span class="n">hi</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>

    <span class="k">cdef</span><span class="p">:</span>
        <span class="kt">Py_ssize_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
        <span class="kt">stype</span> <span class="n">key</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nf">while </span><span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">lo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">A</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">A</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>

      
<span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.initializedcheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython.binding</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">merge_sort_cython</span><span class="p">(</span>
    <span class="kt">stype</span><span class="p">[:]</span> <span class="n">A</span><span class="p">,</span> 
    <span class="kt">stype</span><span class="p">[:]</span> <span class="n">Aux</span><span class="p">,</span> 
    <span class="kt">Py_ssize_t</span> <span class="n">lo</span><span class="p">,</span> 
    <span class="kt">Py_ssize_t</span> <span class="n">hi</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>

    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">mid</span>

    <span class="nf">if </span><span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">&gt;</span> <span class="n">SMALL_MERGESORT_CYTHON</span><span class="p">):</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="p">((</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nf">merge_sort_cython</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span> 
        <span class="nf">merge_sort_cython</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>  
        <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">A</span><span class="p">[</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span> 
            <span class="nf">merge_cython</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Aux</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> 
                <span class="n">Aux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">insertion_sort_cython</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>


<span class="k">cpdef</span> <span class="nf">merge_sort_main_cython</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Aux</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="nf">merge_sort_cython</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">B</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">B</span> <span class="o">=</span> <span class="nf">merge_sort_main_cython</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="numba-implementation">Numba implementation</h2>

<p>The Numba implementation can sort any NumPy numeric type.</p>

<p>Also, we are using the Numba <em>nopython mode</em>. From Numba’s documentation:</p>

<blockquote>
  <p>Numba has two compilation modes: <em>nopython mode</em> and <em>object mode</em>. The former produces much faster code, but has limitations that can force Numba to fall back to the latter. To prevent Numba from falling back, and instead raise an error, pass <code class="language-plaintext highlighter-rouge">nopython=True</code>.</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SMALL_MERGESORT_NUMBA</span> <span class="o">=</span> <span class="mi">40</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">merge_numba</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Aux</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span><span class="p">):</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">lo</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">mid</span><span class="p">:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">hi</span><span class="p">:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insertion_sort_numba</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nf">while </span><span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">lo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">A</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">A</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">merge_sort_numba</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Aux</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">&gt;</span> <span class="n">SMALL_MERGESORT_NUMBA</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="p">((</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nf">merge_sort_numba</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
        <span class="nf">merge_sort_numba</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">A</span><span class="p">[</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="nf">merge_numba</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Aux</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">Aux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">insertion_sort_numba</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">merge_sort_main_numba</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Aux</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="nf">merge_sort_numba</span><span class="p">(</span><span class="n">Aux</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">B</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">B</span> <span class="o">=</span> <span class="nf">merge_sort_main_numba</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="timings">Timings</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span> <span class="o">=</span> <span class="n">perfplot</span><span class="p">.</span><span class="nf">bench</span><span class="p">(</span>
    <span class="n">setup</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="n">kernels</span><span class="o">=</span><span class="p">[</span>
        <span class="k">lambda</span> <span class="n">A</span><span class="p">:</span> <span class="nf">merge_sort_main_cython</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
        <span class="k">lambda</span> <span class="n">A</span><span class="p">:</span> <span class="nf">merge_sort_main_numba</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
        <span class="k">lambda</span> <span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">mergesort</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">Cython</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Numba</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NumPy</span><span class="sh">"</span><span class="p">],</span>
    <span class="n">n_range</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span> <span class="o">**</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)],</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ms</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">loglog</span><span class="p">(</span>
    <span class="n">out</span><span class="p">.</span><span class="n">n_range</span><span class="p">,</span>
    <span class="n">out</span><span class="p">.</span><span class="n">n_range</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">n_range</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0e-8</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">o-</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">$c \; n \; log(n)$</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">loglog</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">n_range</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">timings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-9</span><span class="p">,</span> <span class="sh">"</span><span class="s">o-</span><span class="sh">"</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Cython</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">loglog</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">n_range</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">timings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-9</span><span class="p">,</span> <span class="sh">"</span><span class="s">o-</span><span class="sh">"</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Numba</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">loglog</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">n_range</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">timings</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-9</span><span class="p">,</span> <span class="sh">"</span><span class="s">o-</span><span class="sh">"</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">NumPy</span><span class="sh">"</span><span class="p">)</span>
<span class="n">markers</span> <span class="o">=</span> <span class="nf">iter</span><span class="p">([</span><span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">v</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">^</span><span class="sh">"</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_lines</span><span class="p">()):</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span>
    <span class="n">line</span><span class="p">.</span><span class="nf">set_marker</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Runtime [s]</span><span class="sh">"</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">n = len(A)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Timings of merge sort</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="600" src="/img/2020-12-30_01/output_15_0.png" alt="Timings" />
</p>

<h2 id="conclusion">Conclusion</h2>

<p>Numba is really easy to use. When dealing with NumPy arrays, it is impressive that it can perform as well as efficient C or Cython just by adding a simple decorator to a Python function.</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://aetperf-github-io-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
