<p align="center">
  <img width="300" src="/img/2022-10-04_01/parquet_logo.jpg" alt="query_1" />
</p>

<p>In this notebook, we are going to query some <a href="https://parquet.apache.org/"><em>Parquet</em></a> files with the following SQL engines:</p>
<ul>
  <li><a href="https://duckdb.org/"><em>DuckDB</em></a> : an in-process SQL OLAP database management system. We are going to use its <a href="https://duckdb.org/docs/api/python/reference/">Python Client API</a> (MIT license).</li>
  <li><a href="https://help.tableau.com/current/api/hyper_api/en-us/reference/sql/index.html"><em>Tableau Hyper</em></a> : an in-memory data engine. We are going to interact with this engine using the <a href="https://help.tableau.com/current/api/hyper_api/en-us/index.html">tableauhyperapi</a> Python package (Proprietary License).</li>
</ul>

<p>Both of these tools are optimized for Online analytical processing (OLAP). We do not want to modify the data but launch queries that require processing a large amount of data. DuckDB and Tableau Hyper make use of some vectorized engine and some amount of parallel processing, well suited for the columnar storage format of <em>Parquet</em> files. This is very well described in <a href="https://duckdb.org/2021/06/25/querying-parquet.html">this</a> post from the DuckDB team. Here is a quote from this blog post:</p>

<blockquote>
  <p>DuckDB will read the Parquet files in a streaming fashion, which means you can perform queries on large Parquet files that do not fit in your main memory.</p>
</blockquote>

<p>Tableau Hyper engine has the ability to read <em>Parquet</em> files using the <a href="https://help.tableau.com/current/api/hyper_api/en-us/reference/sql/external-formats.html#EXTERNAL-FORMAT-PARQUET"><code class="language-plaintext highlighter-rouge">external</code></a> keyword.</p>

<blockquote>
  <p>External data can be read directly in a SQL query using the set returning function external. In this case, no Hyper table is involved, so such a query can even be used if no database is attached to the current session.</p>
</blockquote>

<p>The <em>Parquet</em> files correspond to a very specific use case, since they all describe some road networks from the US or Europe. The US road networks were imported in a previous post: <a href="https://aetperf.github.io/2022/09/22/Download-some-benchmark-road-networks-for-Shortest-Paths-algorithms.html">Download some benchmark road networks for Shortest Paths algorithms</a>. The Europe networks were downloaded from <a href="https://i11www.iti.kit.edu/resources/roadgraphs.php">this</a> web page and converted to <em>Parquet</em> files. We are only going to use the edge table, not the node coordinates one. The SQL queries in this notebook are also very specific, in a sense that they are related to the graph theory domain. Here are the things that we are going to compute:</p>
<ol>
  <li>occurence of parallel edges</li>
  <li>vertex and edge counts</li>
  <li>count of connected vertices</li>
  <li>count of vertices with one incoming and one outgoing egde</li>
  <li>degree distribution</li>
</ol>

<p>For each query and SQL engine, we are going to measure the elapsed time. In this post, we <strong>did not</strong> measure the memory consumption.</p>

<p><strong>Notes</strong>:</p>
<ul>
  <li>The <em>Parquet</em> files are not compressed.</li>
  <li>both engines usually make use of their own optimized file format, e.g. <code class="language-plaintext highlighter-rouge">.hyper</code> files for <em>Tableau hyper</em>. However, they both support direct querying of <em>CSV</em> or <em>Parquet</em> files.</li>
  <li>We are going to use <em>DuckDB</em> and <em>Tableau Hyper</em> with the <strong>default configuration</strong>.</li>
  <li>Most of the SQL queries could probably be optimized, however we believe that they are efficient enough for the comparison purpose of this short post.</li>
  <li>In all the elapsed time bar charts, lower is better.</li>
</ul>

<h2 id="imports">Imports</h2>

<p>Note that both tools are very easy to install:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip <span class="nb">install </span>duckdb  
<span class="nv">$ </span>pip <span class="nb">install </span>tableauhyperapi  
</code></pre></div></div>

<p>Here are the imports:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>

<span class="kn">import</span> <span class="n">duckdb</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="n">pandas.testing</span> <span class="kn">import</span> <span class="n">assert_frame_equal</span>
<span class="kn">from</span> <span class="n">tableauhyperapi</span> <span class="kn">import</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">HyperProcess</span><span class="p">,</span> <span class="n">Telemetry</span>

<span class="n">pd</span><span class="p">.</span><span class="nf">set_option</span><span class="p">(</span><span class="sh">"</span><span class="s">display.precision</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Pandas float number display
</span><span class="n">TELEMETRY</span> <span class="o">=</span> <span class="n">Telemetry</span><span class="p">.</span><span class="n">DO_NOT_SEND_USAGE_DATA_TO_TABLEAU</span>  <span class="c1"># not sending telemetry data to Tableau
</span><span class="n">FS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># figure size
</span><span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># figure transparency
</span></code></pre></div></div>

<p>Package versions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Python         : 3.10.6
duckdb         : 0.5.1
tableauhyperapi: 0.0.15530
pandas         : 1.5.0
</code></pre></div></div>

<p>System information:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OS             : Linux
Architecture   : 64bit
CPU            : Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz
CPU cores      : 8
RAM            : 32GB
</code></pre></div></div>

<h2 id="apache-parquet-files">Apache Parquet files</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">BAY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">COL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">FLA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NW</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CAL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">LKS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">W</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CTR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">USA</span><span class="sh">"</span><span class="p">]</span>

<span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">parquet_graph_file_paths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">parquet_file_sizes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">/home/francois/Data/Disk_1/DIMACS_road_networks/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">/USA-road-t.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.gr.parquet</span><span class="sh">"</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">parquet_file_size_MB</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">parquet_graph_file_path</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0e-6</span>
    <span class="p">)</span>
    <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parquet_graph_file_path</span>

<span class="n">names_osmr</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">osm-bawu</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">osm-ger</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">osm-eur</span><span class="sh">"</span><span class="p">]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="n">names_osmr</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names_osmr</span><span class="p">:</span>
    <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">/home/francois/Data/Disk_1/OSMR/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.gr.parquet</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">parquet_file_size_MB</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">parquet_graph_file_path</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0e-6</span>
    <span class="p">)</span>
    <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parquet_graph_file_path</span>
<span class="n">ordered_names</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">NY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">BAY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">COL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">FLA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NW</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CAL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">osm-bawu</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">LKS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">W</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CTR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">osm-ger</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">USA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">osm-eur</span><span class="sh">"</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">stats_df</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">"</span><span class="s">parquet_file_size_MB</span><span class="sh">"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">stats_df</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>parquet_file_size_MB</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NY</th>
      <td>9.11</td>
    </tr>
    <tr>
      <th>BAY</th>
      <td>10.14</td>
    </tr>
    <tr>
      <th>COL</th>
      <td>13.32</td>
    </tr>
    <tr>
      <th>FLA</th>
      <td>31.86</td>
    </tr>
    <tr>
      <th>NW</th>
      <td>34.43</td>
    </tr>
    <tr>
      <th>NE</th>
      <td>46.36</td>
    </tr>
    <tr>
      <th>CAL</th>
      <td>56.40</td>
    </tr>
    <tr>
      <th>LKS</th>
      <td>82.57</td>
    </tr>
    <tr>
      <th>E</th>
      <td>105.59</td>
    </tr>
    <tr>
      <th>osm-bawu</th>
      <td>106.99</td>
    </tr>
    <tr>
      <th>W</th>
      <td>184.64</td>
    </tr>
    <tr>
      <th>CTR</th>
      <td>428.21</td>
    </tr>
    <tr>
      <th>USA</th>
      <td>702.06</td>
    </tr>
    <tr>
      <th>osm-ger</th>
      <td>730.79</td>
    </tr>
    <tr>
      <th>osm-eur</th>
      <td>6112.20</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="first-query--parallel-edges">First query : parallel edges</h2>

<p>In this first query, we want to check if there are parallel edges in the graph. This should not happen with the US networks, because we removed the parallel edges when we created the <em>parquet</em> files in a <a href="https://aetperf.github.io/2022/09/22/Download-some-benchmark-road-networks-for-Shortest-Paths-algorithms.html">previous post</a>. When we imported the Europe networks, we created the <em>parquet</em> files by chunks, so we can guarantee that there is no parallel edge within each chunk, but nor overall. Here is the query:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_1</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
SELECT CASE WHEN COUNT(*) &gt; 0 THEN 1 ELSE 0 END 
FROM (
    SELECT source, target, COUNT(*)
    FROM graph_edges
    GROUP BY source, target
    HAVING COUNT(*) &gt; 1
)</span><span class="sh">"""</span>
</code></pre></div></div>

<p>We expect this query to return 0 for each graph.</p>

<h3 id="duckdb">DuckDB</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_duckdb</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">connect</span><span class="p">()</span>

    <span class="c1"># query
</span>    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query_1</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">read_parquet(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">duplicates</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">duplicates</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">duplicates</span>

    <span class="k">assert</span> <span class="n">duplicates</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_1_DuckDB</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="n">res_duckdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_duckdb</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="tableau-hyper">Tableau Hyper</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_hyper</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nc">HyperProcess</span><span class="p">(</span><span class="n">telemetry</span><span class="o">=</span><span class="n">TELEMETRY</span><span class="p">)</span> <span class="k">as</span> <span class="n">hyper</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>

        <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">with</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">hyper</span><span class="p">.</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="c1"># query
</span>            <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query_1</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">external(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">, FORMAT =&gt; </span><span class="sh">'</span><span class="s">parquet</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">execute_scalar_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">duplicates</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">duplicates</span>

        <span class="k">assert</span> <span class="n">duplicates</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_1_Hyper</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>
<span class="n">res_hyper_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_hyper</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="validation">Validation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert_frame_equal</span><span class="p">(</span><span class="n">res_duckdb_df</span><span class="p">,</span> <span class="n">res_hyper_df</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="elapsed-time">Elapsed time</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ordered_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">values</span><span class="p">]]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">query_1</span><span class="sh">"</span><span class="p">)]</span>
<span class="n">query_1_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">query_1_df</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">"</span><span class="s">DuckDB</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Hyper</span><span class="sh">"</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Query_1</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Network</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Elapsed time (s) - Log scale</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-10-04_01/output_19_0.png" alt="query_1" />
</p>

<h3 id="results">Results</h3>

<p>There is no parallel edge in any of the networks.</p>

<h2 id="second-query--vertex-and-edge-counts">Second query : vertex and edge counts</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_2</span> <span class="o">=</span> <span class="sh">"</span><span class="s">SELECT COUNT(*), MAX(source), MAX(target) FROM graph_edges</span><span class="sh">"</span>
</code></pre></div></div>

<h3 id="duckdb-1">DuckDB</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_duckdb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">connect</span><span class="p">()</span>

    <span class="c1"># query
</span>    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query_2</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">read_parquet(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">edge_count</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vertex_count</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex_count</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_count</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_2_DuckDB</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex_count</span>
    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_count</span>
<span class="n">res_duckdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_duckdb</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="tableau-hyper-1">Tableau Hyper</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_hyper</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nc">HyperProcess</span><span class="p">(</span><span class="n">telemetry</span><span class="o">=</span><span class="n">TELEMETRY</span><span class="p">)</span> <span class="k">as</span> <span class="n">hyper</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">with</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">hyper</span><span class="p">.</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="c1"># query
</span>            <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query_2</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">external(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">, FORMAT =&gt; </span><span class="sh">'</span><span class="s">parquet</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">execute_list_query</span><span class="p">(</span><span class="n">query</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="n">edge_count</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vertex_count</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_2_Hyper</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex_count</span>
        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_count</span>
<span class="n">res_hyper_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_hyper</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="validation-1">Validation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert_frame_equal</span><span class="p">(</span><span class="n">res_duckdb_df</span><span class="p">,</span> <span class="n">res_hyper_df</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="elapsed-time-1">Elapsed time</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ordered_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">values</span><span class="p">]]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">query_2</span><span class="sh">"</span><span class="p">)]</span>
<span class="n">query_2_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">query_2_df</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">"</span><span class="s">DuckDB</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Hyper</span><span class="sh">"</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Query_2</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Network</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Elapsed time (s) - Log scale</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-10-04_01/output_31_0.png" alt="query_2" />
</p>

<h3 id="results-1">Results</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span><span class="p">[[</span><span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>vertex_count</th>
      <th>edge_count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NY</th>
      <td>264346</td>
      <td>730100</td>
    </tr>
    <tr>
      <th>BAY</th>
      <td>321270</td>
      <td>794830</td>
    </tr>
    <tr>
      <th>COL</th>
      <td>435666</td>
      <td>1042400</td>
    </tr>
    <tr>
      <th>FLA</th>
      <td>1070376</td>
      <td>2687902</td>
    </tr>
    <tr>
      <th>NW</th>
      <td>1207945</td>
      <td>2820774</td>
    </tr>
    <tr>
      <th>NE</th>
      <td>1524453</td>
      <td>3868020</td>
    </tr>
    <tr>
      <th>CAL</th>
      <td>1890815</td>
      <td>4630444</td>
    </tr>
    <tr>
      <th>osm-bawu</th>
      <td>3064263</td>
      <td>6183798</td>
    </tr>
    <tr>
      <th>LKS</th>
      <td>2758119</td>
      <td>6794808</td>
    </tr>
    <tr>
      <th>E</th>
      <td>3598623</td>
      <td>8708058</td>
    </tr>
    <tr>
      <th>W</th>
      <td>6262104</td>
      <td>15119284</td>
    </tr>
    <tr>
      <th>CTR</th>
      <td>14081816</td>
      <td>33866826</td>
    </tr>
    <tr>
      <th>osm-ger</th>
      <td>20690320</td>
      <td>41791542</td>
    </tr>
    <tr>
      <th>USA</th>
      <td>23947347</td>
      <td>57708624</td>
    </tr>
    <tr>
      <th>osm-eur</th>
      <td>173789185</td>
      <td>347997111</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="third-query--count-of-connected-vertices">Third query : count of connected vertices</h2>

<p>Some vertices are isolated in the graph : this means that their degree is 0. We want to count the number of connected vertices in the graph (not isolated).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_3</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
WITH edges AS (
    SELECT source, target 
    FROM graph_edges)
SELECT COUNT(*) 
FROM (
    SELECT source AS node 
    FROM edges     
        UNION     
    SELECT target AS node 
    FROM edges)</span><span class="sh">"""</span>
</code></pre></div></div>

<h3 id="duckdb-2">DuckDB</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_duckdb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">connect</span><span class="p">()</span>

    <span class="c1"># query
</span>    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query_3</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">read_parquet(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">connected_vertices</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">connected_vertices</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">connected_vertices</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">mean_degree</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">edge_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">/</span> <span class="n">connected_vertices</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_3_DuckDB</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">connected_vertices</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">connected_vertices</span>
<span class="n">res_duckdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_duckdb</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="tableau-hyper-2">Tableau Hyper</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_hyper</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nc">HyperProcess</span><span class="p">(</span><span class="n">telemetry</span><span class="o">=</span><span class="n">TELEMETRY</span><span class="p">)</span> <span class="k">as</span> <span class="n">hyper</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">with</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">hyper</span><span class="p">.</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="c1"># query
</span>            <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query_3</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">external(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">, FORMAT =&gt; </span><span class="sh">'</span><span class="s">parquet</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">connected_vertices</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">execute_scalar_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_3_Hyper</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">connected_vertices</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">connected_vertices</span>
<span class="n">res_hyper_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_hyper</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="validation-2">Validation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert_frame_equal</span><span class="p">(</span><span class="n">res_duckdb_df</span><span class="p">,</span> <span class="n">res_hyper_df</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="elapsed-time-2">Elapsed time</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ordered_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">values</span><span class="p">]]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">query_3</span><span class="sh">"</span><span class="p">)]</span>
<span class="n">query_3_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">query_3_df</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">"</span><span class="s">DuckDB</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Hyper</span><span class="sh">"</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Query_3</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Network</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Elapsed time (s) - Log scale</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-10-04_01/output_44_0.png" alt="query_3" />
</p>

<p>We observe that the elapsed time measures for the largest network differ a lot between DuckDB and Tableau Hyper:</p>

<table>
  <thead>
    <tr>
      <th>Engine</th>
      <th style="text-align: right">Elapsed time (s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>DuckDB</td>
      <td style="text-align: right">38.71</td>
    </tr>
    <tr>
      <td>Tableau Hyper</td>
      <td style="text-align: right">357.47</td>
    </tr>
  </tbody>
</table>

<h3 id="results-2">Results</h3>

<p>There is no isolated vertex in any of the network.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span><span class="p">[[</span><span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">connected_vertices</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mean_degree</span><span class="sh">"</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>vertex_count</th>
      <th>connected_vertices</th>
      <th>mean_degree</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NY</th>
      <td>264346</td>
      <td>264346</td>
      <td>2.76</td>
    </tr>
    <tr>
      <th>BAY</th>
      <td>321270</td>
      <td>321270</td>
      <td>2.47</td>
    </tr>
    <tr>
      <th>COL</th>
      <td>435666</td>
      <td>435666</td>
      <td>2.39</td>
    </tr>
    <tr>
      <th>FLA</th>
      <td>1070376</td>
      <td>1070376</td>
      <td>2.51</td>
    </tr>
    <tr>
      <th>NW</th>
      <td>1207945</td>
      <td>1207945</td>
      <td>2.34</td>
    </tr>
    <tr>
      <th>NE</th>
      <td>1524453</td>
      <td>1524453</td>
      <td>2.54</td>
    </tr>
    <tr>
      <th>CAL</th>
      <td>1890815</td>
      <td>1890815</td>
      <td>2.45</td>
    </tr>
    <tr>
      <th>osm-bawu</th>
      <td>3064263</td>
      <td>3064263</td>
      <td>2.02</td>
    </tr>
    <tr>
      <th>LKS</th>
      <td>2758119</td>
      <td>2758119</td>
      <td>2.46</td>
    </tr>
    <tr>
      <th>E</th>
      <td>3598623</td>
      <td>3598623</td>
      <td>2.42</td>
    </tr>
    <tr>
      <th>W</th>
      <td>6262104</td>
      <td>6262104</td>
      <td>2.41</td>
    </tr>
    <tr>
      <th>CTR</th>
      <td>14081816</td>
      <td>14081816</td>
      <td>2.41</td>
    </tr>
    <tr>
      <th>osm-ger</th>
      <td>20690320</td>
      <td>20690320</td>
      <td>2.02</td>
    </tr>
    <tr>
      <th>USA</th>
      <td>23947347</td>
      <td>23947347</td>
      <td>2.41</td>
    </tr>
    <tr>
      <th>osm-eur</th>
      <td>173789185</td>
      <td>173789185</td>
      <td>2.00</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="forth-query--count-of-vertices-with-one-incoming-and-one-outgoing-egde">Forth query : count of vertices with one incoming and one outgoing egde</h2>

<p>Count of degree 2 nodes with <em>in-degree=out-degree=1</em>. In the following, we refer to these vertices as <em>in-out vertices</em>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_4</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    WITH TPARQUET AS (
        SELECT source, target 
        FROM graph_edges),
    TSOURCE AS (
        SELECT source AS node, COUNT(*) 
        FROM TPARQUET 
        GROUP BY source HAVING COUNT(*)=1),
    TTARGET AS (
        SELECT target AS node, COUNT(*) 
        FROM TPARQUET GROUP BY target HAVING COUNT(*)=1),
    TJOIN AS (
        SELECT s.node 
        FROM TSOURCE s 
        INNER JOIN TTARGET t ON s.node = t.node)
    SELECT COUNT(*) from TJOIN</span><span class="sh">"""</span>
</code></pre></div></div>

<h3 id="duckdb-3">DuckDB</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_duckdb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">connect</span><span class="p">()</span>

    <span class="c1"># query
</span>    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query_4</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">read_parquet(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">inout_vertices</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">inout_vertices</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">inout_vertices</span>
    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_4_DuckDB</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">inout_vertices</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">inout_vertices</span>
<span class="n">res_duckdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_duckdb</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="tableau-hyper-3">Tableau Hyper</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_hyper</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nc">HyperProcess</span><span class="p">(</span><span class="n">telemetry</span><span class="o">=</span><span class="n">TELEMETRY</span><span class="p">)</span> <span class="k">as</span> <span class="n">hyper</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">with</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">hyper</span><span class="p">.</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="c1"># query
</span>            <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query_4</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">external(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">, FORMAT =&gt; </span><span class="sh">'</span><span class="s">parquet</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">inout_vertices</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">execute_scalar_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_4_Hyper</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">inout_vertices</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">inout_vertices</span>
<span class="n">res_hyper_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_hyper</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="validation-3">Validation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert_frame_equal</span><span class="p">(</span><span class="n">res_duckdb_df</span><span class="p">,</span> <span class="n">res_hyper_df</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="elapsed-time-3">Elapsed time</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ordered_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">values</span><span class="p">]]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">query_4</span><span class="sh">"</span><span class="p">)]</span>
<span class="n">query_4_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">query_4_df</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">"</span><span class="s">DuckDB</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Hyper</span><span class="sh">"</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Query_4</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Network</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Elapsed time (s) - Log scale</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-10-04_01/output_57_0.png" alt="query_4" />
</p>

<h3 id="results-3">Results</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span><span class="p">[</span><span class="sh">"</span><span class="s">ratio</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">inout_vertices</span> <span class="o">/</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">vertex_count</span>
<span class="n">stats_df</span><span class="p">[[</span><span class="sh">"</span><span class="s">inout_vertices</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ratio</span><span class="sh">"</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>inout_vertices</th>
      <th>vertex_count</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NY</th>
      <td>41169</td>
      <td>264346</td>
      <td>0.16</td>
    </tr>
    <tr>
      <th>BAY</th>
      <td>73109</td>
      <td>321270</td>
      <td>0.23</td>
    </tr>
    <tr>
      <th>COL</th>
      <td>82537</td>
      <td>435666</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>FLA</th>
      <td>210849</td>
      <td>1070376</td>
      <td>0.20</td>
    </tr>
    <tr>
      <th>NW</th>
      <td>282638</td>
      <td>1207945</td>
      <td>0.23</td>
    </tr>
    <tr>
      <th>NE</th>
      <td>288695</td>
      <td>1524453</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>CAL</th>
      <td>373947</td>
      <td>1890815</td>
      <td>0.20</td>
    </tr>
    <tr>
      <th>osm-bawu</th>
      <td>398242</td>
      <td>3064263</td>
      <td>0.13</td>
    </tr>
    <tr>
      <th>LKS</th>
      <td>478263</td>
      <td>2758119</td>
      <td>0.17</td>
    </tr>
    <tr>
      <th>E</th>
      <td>764838</td>
      <td>3598623</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>W</th>
      <td>1209550</td>
      <td>6262104</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>CTR</th>
      <td>2787565</td>
      <td>14081816</td>
      <td>0.20</td>
    </tr>
    <tr>
      <th>osm-ger</th>
      <td>2874055</td>
      <td>20690320</td>
      <td>0.14</td>
    </tr>
    <tr>
      <th>USA</th>
      <td>4762005</td>
      <td>23947347</td>
      <td>0.20</td>
    </tr>
    <tr>
      <th>osm-eur</th>
      <td>20309942</td>
      <td>173789185</td>
      <td>0.12</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="fifth-query--degree-distribution">Fifth query : degree distribution</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_5</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    CREATE TEMP TABLE t_edges AS 
        SELECT source, target 
        FROM graph_edges;
    CREATE TEMP TABLE t_nodes AS
        SELECT source AS node 
        FROM t_edges     
            UNION ALL
        SELECT target AS node 
        FROM t_edges;
    CREATE TEMP TABLE t_deg AS
        SELECT COUNT(*) AS deg
        FROM t_nodes
        GROUP BY node;
    SELECT deg, COUNT(*) AS n_occ 
    FROM t_deg
    GROUP BY deg
    ORDER BY deg ASC;</span><span class="sh">"""</span>
</code></pre></div></div>

<h3 id="duckdb-4">DuckDB</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_duckdb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">connect</span><span class="p">()</span>
    
    <span class="c1"># query
</span>    <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query_5</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">read_parquet(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">queries</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nf">removesuffix</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sq</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>
    <span class="n">sq</span> <span class="o">=</span> <span class="n">queries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">sq</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()</span>

    <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_5_DuckDB</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vertex_count</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">res_duckdb</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">degree_</span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">degree</span><span class="p">).</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vertex_count</span>

<span class="n">res_duckdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_duckdb</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">res_duckdb_df</span> <span class="o">=</span> <span class="n">res_duckdb_df</span><span class="p">.</span><span class="nf">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res_duckdb_df</span> <span class="o">=</span> <span class="n">res_duckdb_df</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="tableau-hyper-4">Tableau Hyper</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res_hyper</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nc">HyperProcess</span><span class="p">(</span><span class="n">telemetry</span><span class="o">=</span><span class="n">TELEMETRY</span><span class="p">)</span> <span class="k">as</span> <span class="n">hyper</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">with</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">hyper</span><span class="p">.</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="n">parquet_graph_file_path</span> <span class="o">=</span> <span class="n">parquet_graph_file_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># query
</span>            <span class="n">start</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query_5</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">graph_edges</span><span class="sh">"</span><span class="p">,</span>
                <span class="sa">f</span><span class="sh">"</span><span class="s">external(</span><span class="sh">'</span><span class="si">{</span><span class="n">parquet_graph_file_path</span><span class="si">}</span><span class="sh">'</span><span class="s">, FORMAT =&gt; </span><span class="sh">'</span><span class="s">parquet</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">queries</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nf">removesuffix</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sq</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">connection</span><span class="p">.</span><span class="nf">execute_command</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>
            <span class="n">sq</span> <span class="o">=</span> <span class="n">queries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">execute_list_query</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>

            <span class="n">elapsed_time_s</span> <span class="o">=</span> <span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vertex_count</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">degree_</span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">degree</span><span class="p">).</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vertex_count</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">query_5_Hyper</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed_time_s</span>

        <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vertex_count</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res_hyper</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="sh">"</span><span class="s">degree_</span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">degree</span><span class="p">).</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vertex_count</span>
<span class="n">res_hyper_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">res_hyper</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">res_hyper_df</span> <span class="o">=</span> <span class="n">res_hyper_df</span><span class="p">.</span><span class="nf">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res_hyper_df</span> <span class="o">=</span> <span class="n">res_hyper_df</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="validation-4">Validation</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert_frame_equal</span><span class="p">(</span><span class="n">res_duckdb_df</span><span class="p">,</span> <span class="n">res_hyper_df</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="elapsed-time-4">Elapsed time</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ordered_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">values</span><span class="p">]]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">query_5</span><span class="sh">"</span><span class="p">)]</span>
<span class="n">query_5_df</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">query_5_df</span><span class="p">.</span><span class="n">plot</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FS</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">"</span><span class="s">DuckDB</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Hyper</span><span class="sh">"</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Query_5</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Network</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Elapsed time (s) - Log scale</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
  <img width="800" src="/img/2022-10-04_01/output_71_0.png" alt="query_5" />
</p>

<h3 id="results-4">Results</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">degree_cols</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats_df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">degree_</span><span class="sh">"</span><span class="p">)])</span>
<span class="n">stats_df</span><span class="p">[</span><span class="n">degree_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">[</span><span class="n">degree_cols</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">degrees</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span>  <span class="n">stats_df</span><span class="p">[</span><span class="n">degree_cols</span><span class="p">].</span><span class="nf">div</span><span class="p">(</span><span class="n">stats_df</span><span class="p">[</span><span class="sh">"</span><span class="s">vertex_count</span><span class="sh">"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">.</span><span class="n">columns</span>
<span class="n">degrees</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
<span class="n">tot</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">degrees</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">[</span><span class="nf">list</span><span class="p">(</span><span class="n">tot</span><span class="p">[</span><span class="n">tot</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">].</span><span class="n">index</span><span class="p">.</span><span class="n">values</span><span class="p">)]</span>
<span class="n">degrees</span><span class="p">[</span><span class="sh">'</span><span class="s">total</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">styler</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">background_gradient</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">YlOrRd</span><span class="sh">'</span><span class="p">)</span>
<span class="n">styler</span> <span class="o">=</span> <span class="n">styler</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">styler</span> 
</code></pre></div></div>

<style type="text/css">
#T_9f598_row0_col0, #T_9f598_row0_col2 {
  background-color: #ffe997;
  color: #000000;
}
#T_9f598_row0_col1, #T_9f598_row0_col3, #T_9f598_row0_col5, #T_9f598_row0_col8, #T_9f598_row1_col1, #T_9f598_row1_col3, #T_9f598_row1_col5, #T_9f598_row1_col7, #T_9f598_row1_col8, #T_9f598_row2_col1, #T_9f598_row2_col3, #T_9f598_row2_col5, #T_9f598_row2_col7, #T_9f598_row2_col8, #T_9f598_row3_col1, #T_9f598_row3_col3, #T_9f598_row3_col5, #T_9f598_row3_col7, #T_9f598_row3_col8, #T_9f598_row4_col1, #T_9f598_row4_col3, #T_9f598_row4_col5, #T_9f598_row4_col7, #T_9f598_row4_col8, #T_9f598_row5_col1, #T_9f598_row5_col3, #T_9f598_row5_col5, #T_9f598_row5_col7, #T_9f598_row5_col8, #T_9f598_row6_col1, #T_9f598_row6_col3, #T_9f598_row6_col5, #T_9f598_row6_col7, #T_9f598_row6_col8, #T_9f598_row7_col5, #T_9f598_row7_col7, #T_9f598_row7_col8, #T_9f598_row8_col1, #T_9f598_row8_col3, #T_9f598_row8_col5, #T_9f598_row8_col7, #T_9f598_row8_col8, #T_9f598_row9_col1, #T_9f598_row9_col3, #T_9f598_row9_col5, #T_9f598_row9_col7, #T_9f598_row9_col8, #T_9f598_row10_col1, #T_9f598_row10_col3, #T_9f598_row10_col5, #T_9f598_row10_col7, #T_9f598_row10_col8, #T_9f598_row11_col1, #T_9f598_row11_col3, #T_9f598_row11_col5, #T_9f598_row11_col7, #T_9f598_row11_col8, #T_9f598_row12_col5, #T_9f598_row12_col7, #T_9f598_row12_col8, #T_9f598_row13_col1, #T_9f598_row13_col3, #T_9f598_row13_col5, #T_9f598_row13_col7, #T_9f598_row13_col8, #T_9f598_row14_col5, #T_9f598_row14_col7, #T_9f598_row14_col8 {
  background-color: #ffffcc;
  color: #000000;
}
#T_9f598_row0_col4 {
  background-color: #fd9640;
  color: #000000;
}
#T_9f598_row0_col6 {
  background-color: #fede82;
  color: #000000;
}
#T_9f598_row0_col7, #T_9f598_row7_col1, #T_9f598_row7_col3, #T_9f598_row12_col1, #T_9f598_row12_col3, #T_9f598_row14_col3 {
  background-color: #fffecb;
  color: #000000;
}
#T_9f598_row0_col9, #T_9f598_row1_col9, #T_9f598_row2_col9, #T_9f598_row3_col9, #T_9f598_row4_col9, #T_9f598_row5_col9, #T_9f598_row6_col9, #T_9f598_row7_col9, #T_9f598_row8_col9, #T_9f598_row9_col9, #T_9f598_row10_col9, #T_9f598_row11_col9, #T_9f598_row12_col9, #T_9f598_row13_col9, #T_9f598_row14_col9 {
  background-color: #800026;
  color: #f1f1f1;
}
#T_9f598_row1_col0, #T_9f598_row3_col2 {
  background-color: #fedd7e;
  color: #000000;
}
#T_9f598_row1_col2 {
  background-color: #fee187;
  color: #000000;
}
#T_9f598_row1_col4 {
  background-color: #fd9f44;
  color: #000000;
}
#T_9f598_row1_col6, #T_9f598_row8_col6 {
  background-color: #ffeda0;
  color: #000000;
}
#T_9f598_row2_col0, #T_9f598_row5_col0 {
  background-color: #fee38b;
  color: #000000;
}
#T_9f598_row2_col2 {
  background-color: #febe59;
  color: #000000;
}
#T_9f598_row2_col4 {
  background-color: #feb54f;
  color: #000000;
}
#T_9f598_row2_col6, #T_9f598_row13_col6 {
  background-color: #fff0a7;
  color: #000000;
}
#T_9f598_row3_col0, #T_9f598_row6_col0, #T_9f598_row11_col0, #T_9f598_row13_col0 {
  background-color: #fee288;
  color: #000000;
}
#T_9f598_row3_col4 {
  background-color: #fd9e43;
  color: #000000;
}
#T_9f598_row3_col6, #T_9f598_row5_col6, #T_9f598_row7_col0, #T_9f598_row12_col4 {
  background-color: #ffec9f;
  color: #000000;
}
#T_9f598_row4_col0 {
  background-color: #fedc7c;
  color: #000000;
}
#T_9f598_row4_col2 {
  background-color: #fecc68;
  color: #000000;
}
#T_9f598_row4_col4 {
  background-color: #feaf4b;
  color: #000000;
}
#T_9f598_row4_col6 {
  background-color: #fff2ac;
  color: #000000;
}
#T_9f598_row5_col2 {
  background-color: #fede80;
  color: #000000;
}
#T_9f598_row5_col4 {
  background-color: #fd9941;
  color: #000000;
}
#T_9f598_row6_col2 {
  background-color: #fed16e;
  color: #000000;
}
#T_9f598_row6_col4 {
  background-color: #fea848;
  color: #000000;
}
#T_9f598_row6_col6, #T_9f598_row14_col0 {
  background-color: #ffefa4;
  color: #000000;
}
#T_9f598_row7_col2 {
  background-color: #e8241f;
  color: #f1f1f1;
}
#T_9f598_row7_col4 {
  background-color: #ffeda1;
  color: #000000;
}
#T_9f598_row7_col6, #T_9f598_row12_col6 {
  background-color: #fffdc8;
  color: #000000;
}
#T_9f598_row8_col0 {
  background-color: #ffe590;
  color: #000000;
}
#T_9f598_row8_col2 {
  background-color: #fec45f;
  color: #000000;
}
#T_9f598_row8_col4 {
  background-color: #feb24c;
  color: #000000;
}
#T_9f598_row9_col0 {
  background-color: #fedf83;
  color: #000000;
}
#T_9f598_row9_col2 {
  background-color: #fed572;
  color: #000000;
}
#T_9f598_row9_col4 {
  background-color: #fea546;
  color: #000000;
}
#T_9f598_row9_col6, #T_9f598_row10_col6 {
  background-color: #fff0a8;
  color: #000000;
}
#T_9f598_row10_col0 {
  background-color: #fee289;
  color: #000000;
}
#T_9f598_row10_col2 {
  background-color: #fec863;
  color: #000000;
}
#T_9f598_row10_col4 {
  background-color: #fead4a;
  color: #000000;
}
#T_9f598_row11_col2 {
  background-color: #fec662;
  color: #000000;
}
#T_9f598_row11_col4 {
  background-color: #feb04b;
  color: #000000;
}
#T_9f598_row11_col6 {
  background-color: #ffefa5;
  color: #000000;
}
#T_9f598_row12_col0 {
  background-color: #ffeb9c;
  color: #000000;
}
#T_9f598_row12_col2 {
  background-color: #ec2c21;
  color: #f1f1f1;
}
#T_9f598_row13_col2 {
  background-color: #fec965;
  color: #000000;
}
#T_9f598_row13_col4 {
  background-color: #feae4a;
  color: #000000;
}
#T_9f598_row14_col1, #T_9f598_row14_col6 {
  background-color: #fffec9;
  color: #000000;
}
#T_9f598_row14_col2 {
  background-color: #e0181d;
  color: #f1f1f1;
}
#T_9f598_row14_col4 {
  background-color: #fff1a9;
  color: #000000;
}
</style>

<table id="T_9f598">
  <thead>
    <tr>
      <th class="blank level0">&nbsp;</th>
      <th id="T_9f598_level0_col0" class="col_heading level0 col0">2</th>
      <th id="T_9f598_level0_col1" class="col_heading level0 col1">3</th>
      <th id="T_9f598_level0_col2" class="col_heading level0 col2">4</th>
      <th id="T_9f598_level0_col3" class="col_heading level0 col3">5</th>
      <th id="T_9f598_level0_col4" class="col_heading level0 col4">6</th>
      <th id="T_9f598_level0_col5" class="col_heading level0 col5">7</th>
      <th id="T_9f598_level0_col6" class="col_heading level0 col6">8</th>
      <th id="T_9f598_level0_col7" class="col_heading level0 col7">10</th>
      <th id="T_9f598_level0_col8" class="col_heading level0 col8">12</th>
      <th id="T_9f598_level0_col9" class="col_heading level0 col9">total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_9f598_level0_row0" class="row_heading level0 row0">NY</th>
      <td id="T_9f598_row0_col0" class="data row0 col0">15.57</td>
      <td id="T_9f598_row0_col1" class="data row0 col1">0.00</td>
      <td id="T_9f598_row0_col2" class="data row0 col2">15.27</td>
      <td id="T_9f598_row0_col3" class="data row0 col3">0.00</td>
      <td id="T_9f598_row0_col4" class="data row0 col4">47.11</td>
      <td id="T_9f598_row0_col5" class="data row0 col5">0.00</td>
      <td id="T_9f598_row0_col6" class="data row0 col6">21.56</td>
      <td id="T_9f598_row0_col7" class="data row0 col7">0.43</td>
      <td id="T_9f598_row0_col8" class="data row0 col8">0.06</td>
      <td id="T_9f598_row0_col9" class="data row0 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row1" class="row_heading level0 row1">BAY</th>
      <td id="T_9f598_row1_col0" class="data row1 col0">22.76</td>
      <td id="T_9f598_row1_col1" class="data row1 col1">0.00</td>
      <td id="T_9f598_row1_col2" class="data row1 col2">20.30</td>
      <td id="T_9f598_row1_col3" class="data row1 col3">0.00</td>
      <td id="T_9f598_row1_col4" class="data row1 col4">43.94</td>
      <td id="T_9f598_row1_col5" class="data row1 col5">0.00</td>
      <td id="T_9f598_row1_col6" class="data row1 col6">12.81</td>
      <td id="T_9f598_row1_col7" class="data row1 col7">0.17</td>
      <td id="T_9f598_row1_col8" class="data row1 col8">0.02</td>
      <td id="T_9f598_row1_col9" class="data row1 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row2" class="row_heading level0 row2">COL</th>
      <td id="T_9f598_row2_col0" class="data row2 col0">18.95</td>
      <td id="T_9f598_row2_col1" class="data row2 col1">0.00</td>
      <td id="T_9f598_row2_col2" class="data row2 col2">33.71</td>
      <td id="T_9f598_row2_col3" class="data row2 col3">0.00</td>
      <td id="T_9f598_row2_col4" class="data row2 col4">36.59</td>
      <td id="T_9f598_row2_col5" class="data row2 col5">0.00</td>
      <td id="T_9f598_row2_col6" class="data row2 col6">10.66</td>
      <td id="T_9f598_row2_col7" class="data row2 col7">0.09</td>
      <td id="T_9f598_row2_col8" class="data row2 col8">0.01</td>
      <td id="T_9f598_row2_col9" class="data row2 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row3" class="row_heading level0 row3">FLA</th>
      <td id="T_9f598_row3_col0" class="data row3 col0">19.70</td>
      <td id="T_9f598_row3_col1" class="data row3 col1">0.00</td>
      <td id="T_9f598_row3_col2" class="data row3 col2">22.73</td>
      <td id="T_9f598_row3_col3" class="data row3 col3">0.00</td>
      <td id="T_9f598_row3_col4" class="data row3 col4">44.49</td>
      <td id="T_9f598_row3_col5" class="data row3 col5">0.00</td>
      <td id="T_9f598_row3_col6" class="data row3 col6">12.94</td>
      <td id="T_9f598_row3_col7" class="data row3 col7">0.13</td>
      <td id="T_9f598_row3_col8" class="data row3 col8">0.01</td>
      <td id="T_9f598_row3_col9" class="data row3 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row4" class="row_heading level0 row4">NW</th>
      <td id="T_9f598_row4_col0" class="data row4 col0">23.40</td>
      <td id="T_9f598_row4_col1" class="data row4 col1">0.00</td>
      <td id="T_9f598_row4_col2" class="data row4 col2">28.99</td>
      <td id="T_9f598_row4_col3" class="data row4 col3">0.00</td>
      <td id="T_9f598_row4_col4" class="data row4 col4">38.47</td>
      <td id="T_9f598_row4_col5" class="data row4 col5">0.00</td>
      <td id="T_9f598_row4_col6" class="data row4 col6">9.01</td>
      <td id="T_9f598_row4_col7" class="data row4 col7">0.13</td>
      <td id="T_9f598_row4_col8" class="data row4 col8">0.01</td>
      <td id="T_9f598_row4_col9" class="data row4 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row5" class="row_heading level0 row5">NE</th>
      <td id="T_9f598_row5_col0" class="data row5 col0">18.94</td>
      <td id="T_9f598_row5_col1" class="data row5 col1">0.00</td>
      <td id="T_9f598_row5_col2" class="data row5 col2">21.90</td>
      <td id="T_9f598_row5_col3" class="data row5 col3">0.00</td>
      <td id="T_9f598_row5_col4" class="data row5 col4">45.95</td>
      <td id="T_9f598_row5_col5" class="data row5 col5">0.00</td>
      <td id="T_9f598_row5_col6" class="data row5 col6">12.96</td>
      <td id="T_9f598_row5_col7" class="data row5 col7">0.23</td>
      <td id="T_9f598_row5_col8" class="data row5 col8">0.03</td>
      <td id="T_9f598_row5_col9" class="data row5 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row6" class="row_heading level0 row6">CAL</th>
      <td id="T_9f598_row6_col0" class="data row6 col0">19.78</td>
      <td id="T_9f598_row6_col1" class="data row6 col1">0.00</td>
      <td id="T_9f598_row6_col2" class="data row6 col2">27.53</td>
      <td id="T_9f598_row6_col3" class="data row6 col3">0.00</td>
      <td id="T_9f598_row6_col4" class="data row6 col4">40.89</td>
      <td id="T_9f598_row6_col5" class="data row6 col5">0.00</td>
      <td id="T_9f598_row6_col6" class="data row6 col6">11.66</td>
      <td id="T_9f598_row6_col7" class="data row6 col7">0.14</td>
      <td id="T_9f598_row6_col8" class="data row6 col8">0.01</td>
      <td id="T_9f598_row6_col9" class="data row6 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row7" class="row_heading level0 row7">osm-bawu</th>
      <td id="T_9f598_row7_col0" class="data row7 col0">13.00</td>
      <td id="T_9f598_row7_col1" class="data row7 col1">0.60</td>
      <td id="T_9f598_row7_col2" class="data row7 col2">72.27</td>
      <td id="T_9f598_row7_col3" class="data row7 col3">0.58</td>
      <td id="T_9f598_row7_col4" class="data row7 col4">12.26</td>
      <td id="T_9f598_row7_col5" class="data row7 col5">0.07</td>
      <td id="T_9f598_row7_col6" class="data row7 col6">1.21</td>
      <td id="T_9f598_row7_col7" class="data row7 col7">0.01</td>
      <td id="T_9f598_row7_col8" class="data row7 col8">0.00</td>
      <td id="T_9f598_row7_col9" class="data row7 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row8" class="row_heading level0 row8">LKS</th>
      <td id="T_9f598_row8_col0" class="data row8 col0">17.34</td>
      <td id="T_9f598_row8_col1" class="data row8 col1">0.00</td>
      <td id="T_9f598_row8_col2" class="data row8 col2">32.01</td>
      <td id="T_9f598_row8_col3" class="data row8 col3">0.00</td>
      <td id="T_9f598_row8_col4" class="data row8 col4">37.75</td>
      <td id="T_9f598_row8_col5" class="data row8 col5">0.00</td>
      <td id="T_9f598_row8_col6" class="data row8 col6">12.77</td>
      <td id="T_9f598_row8_col7" class="data row8 col7">0.12</td>
      <td id="T_9f598_row8_col8" class="data row8 col8">0.01</td>
      <td id="T_9f598_row8_col9" class="data row8 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row9" class="row_heading level0 row9">E</th>
      <td id="T_9f598_row9_col0" class="data row9 col0">21.25</td>
      <td id="T_9f598_row9_col1" class="data row9 col1">0.00</td>
      <td id="T_9f598_row9_col2" class="data row9 col2">26.19</td>
      <td id="T_9f598_row9_col3" class="data row9 col3">0.00</td>
      <td id="T_9f598_row9_col4" class="data row9 col4">42.07</td>
      <td id="T_9f598_row9_col5" class="data row9 col5">0.00</td>
      <td id="T_9f598_row9_col6" class="data row9 col6">10.30</td>
      <td id="T_9f598_row9_col7" class="data row9 col7">0.16</td>
      <td id="T_9f598_row9_col8" class="data row9 col8">0.02</td>
      <td id="T_9f598_row9_col9" class="data row9 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row10" class="row_heading level0 row10">W</th>
      <td id="T_9f598_row10_col0" class="data row10 col0">19.32</td>
      <td id="T_9f598_row10_col1" class="data row10 col1">0.00</td>
      <td id="T_9f598_row10_col2" class="data row10 col2">30.72</td>
      <td id="T_9f598_row10_col3" class="data row10 col3">0.00</td>
      <td id="T_9f598_row10_col4" class="data row10 col4">39.33</td>
      <td id="T_9f598_row10_col5" class="data row10 col5">0.00</td>
      <td id="T_9f598_row10_col6" class="data row10 col6">10.49</td>
      <td id="T_9f598_row10_col7" class="data row10 col7">0.13</td>
      <td id="T_9f598_row10_col8" class="data row10 col8">0.01</td>
      <td id="T_9f598_row10_col9" class="data row10 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row11" class="row_heading level0 row11">CTR</th>
      <td id="T_9f598_row11_col0" class="data row11 col0">19.80</td>
      <td id="T_9f598_row11_col1" class="data row11 col1">0.00</td>
      <td id="T_9f598_row11_col2" class="data row11 col2">31.11</td>
      <td id="T_9f598_row11_col3" class="data row11 col3">0.00</td>
      <td id="T_9f598_row11_col4" class="data row11 col4">38.01</td>
      <td id="T_9f598_row11_col5" class="data row11 col5">0.00</td>
      <td id="T_9f598_row11_col6" class="data row11 col6">10.97</td>
      <td id="T_9f598_row11_col7" class="data row11 col7">0.10</td>
      <td id="T_9f598_row11_col8" class="data row11 col8">0.01</td>
      <td id="T_9f598_row11_col9" class="data row11 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row12" class="row_heading level0 row12">osm-ger</th>
      <td id="T_9f598_row12_col0" class="data row12 col0">13.89</td>
      <td id="T_9f598_row12_col1" class="data row12 col1">0.60</td>
      <td id="T_9f598_row12_col2" class="data row12 col2">70.33</td>
      <td id="T_9f598_row12_col3" class="data row12 col3">0.66</td>
      <td id="T_9f598_row12_col4" class="data row12 col4">13.17</td>
      <td id="T_9f598_row12_col5" class="data row12 col5">0.08</td>
      <td id="T_9f598_row12_col6" class="data row12 col6">1.26</td>
      <td id="T_9f598_row12_col7" class="data row12 col7">0.01</td>
      <td id="T_9f598_row12_col8" class="data row12 col8">0.00</td>
      <td id="T_9f598_row12_col9" class="data row12 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row13" class="row_heading level0 row13">USA</th>
      <td id="T_9f598_row13_col0" class="data row13 col0">19.89</td>
      <td id="T_9f598_row13_col1" class="data row13 col1">0.00</td>
      <td id="T_9f598_row13_col2" class="data row13 col2">30.27</td>
      <td id="T_9f598_row13_col3" class="data row13 col3">0.00</td>
      <td id="T_9f598_row13_col4" class="data row13 col4">38.97</td>
      <td id="T_9f598_row13_col5" class="data row13 col5">0.00</td>
      <td id="T_9f598_row13_col6" class="data row13 col6">10.75</td>
      <td id="T_9f598_row13_col7" class="data row13 col7">0.12</td>
      <td id="T_9f598_row13_col8" class="data row13 col8">0.01</td>
      <td id="T_9f598_row13_col9" class="data row13 col9">100.00</td>
    </tr>
    <tr>
      <th id="T_9f598_level0_row14" class="row_heading level0 row14">osm-eur</th>
      <td id="T_9f598_row14_col0" class="data row14 col0">11.69</td>
      <td id="T_9f598_row14_col1" class="data row14 col1">0.84</td>
      <td id="T_9f598_row14_col2" class="data row14 col2">76.03</td>
      <td id="T_9f598_row14_col3" class="data row14 col3">0.50</td>
      <td id="T_9f598_row14_col4" class="data row14 col4">9.80</td>
      <td id="T_9f598_row14_col5" class="data row14 col5">0.05</td>
      <td id="T_9f598_row14_col6" class="data row14 col6">1.09</td>
      <td id="T_9f598_row14_col7" class="data row14 col7">0.01</td>
      <td id="T_9f598_row14_col8" class="data row14 col8">0.00</td>
      <td id="T_9f598_row14_col9" class="data row14 col9">100.00</td>
    </tr>
  </tbody>
</table>

<h2 id="conclusion">Conclusion</h2>

<p><em>Apache Parquet</em> is a column-oriented data file format designed for efficient data storage and retrieval. It is widespread in the data analysis ecosystem. Querying them directly with an efficient SQL engine is really convenient. Both engines, DuckDB and Tableau Hyper are amazing tools, allowing to efficiently query <em>Parquet</em> files, among other capabilities. We only scratched the surface of this feature in this post, with a very specific use case. We observed similar timings for most of the queries. We did not measure memory usage. However, we observed that it is important to write SQL queries that are a little bit optimized regarding memory consumption, when dealing with large datasets and large queries. Also, it is advised to specify a temp directory to the engine, so that it can write some temporary data there (<code class="language-plaintext highlighter-rouge">temp_directory</code> setting with DuckDB).</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://aetperf-github-io-1.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
